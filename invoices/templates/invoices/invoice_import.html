{% extends "base_template.html" %}
{% load static %}

{% block title %}Import Invoices - BusinessSuite{% endblock %}

{% block head-extra %}
<style>
    .drop-zone {
        border: 3px dashed #007bff;
        border-radius: 10px;
        padding: 50px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: #f8f9fa;
        min-height: 300px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .drop-zone:hover {
        background-color: #e9ecef;
        border-color: #0056b3;
    }

    .drop-zone.drag-over {
        background-color: #cce5ff;
        border-color: #004085;
    }

    .drop-zone-icon {
        font-size: 4rem;
        color: #007bff;
        margin-bottom: 20px;
    }

    .file-input {
        display: none;
    }

    .file-list {
        margin-top: 20px;
    }

    .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background-color: white;
    }

    .file-item.processing {
        background-color: #fff3cd;
        border-color: #ffc107;
    }

    .file-item.success {
        background-color: #d4edda;
        border-color: #c3e6cb;
    }

    .file-item.duplicate {
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }

    .file-item.error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }

    .progress-bar-container {
        width: 100%;
        height: 4px;
        background-color: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 5px;
    }

    .progress-bar {
        height: 100%;
        background-color: #007bff;
        width: 0%;
        transition: width 0.3s ease;
    }

    .results-summary {
        margin-top: 30px;
        padding: 20px;
        border-radius: 5px;
        background-color: #f8f9fa;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.15em;
    }

    .progress-message {
        margin-top: 20px;
        padding: 15px;
        background-color: #e7f3ff;
        border-left: 4px solid #007bff;
        border-radius: 4px;
        display: none;
    }

    .progress-message.active {
        display: block;
    }

    .file-detail {
        margin-top: 5px;
        font-size: 0.875rem;
        color: #6c757d;
    }

    .mark-paid-checkbox {
        cursor: pointer;
    }

    .form-check-label {
        cursor: pointer;
        font-size: 0.875rem;
        color: #28a745;
        font-weight: 500;
    }

    .form-check-label i {
        color: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content">
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-file-earmark-arrow-up"></i> Import Invoices</h2>
            <a href="{% url 'invoice-list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Invoices
            </a>
        </div>

        <!-- Instructions -->
        <div class="alert alert-info mb-4">
            <h5><i class="bi bi-info-circle"></i> Instructions</h5>
            <ul class="mb-0">
                <li>Upload invoice files in PDF, Excel (.xlsx, .xls), or Word (.docx, .doc) format</li>
                <li>Drag and drop files into the zone below or click to browse</li>
                <li>Multiple files can be uploaded at once</li>
                <li>The system will automatically extract customer and invoice data using AI</li>
                <li>Existing customers will be matched automatically, new ones will be created</li>
                <li>Duplicate invoices will be detected and skipped</li>
            </ul>
        </div>

        <!-- LLM Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-robot"></i> AI Model Configuration</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label for="llmProvider" class="form-label fw-bold">Provider:</label>
                        <select class="form-select" id="llmProvider">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <label for="llmModel" class="form-label fw-bold">Model:</label>
                        <select class="form-select" id="llmModel">
                            <option value="">Select provider first...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-light mb-0 mt-2" role="alert">
                            <small>
                                <strong>Current:</strong><br>
                                <span class="badge bg-info text-dark">{{ current_provider }}</span>
                                <span class="badge bg-success">{{ current_model }}</span>
                            </small>
                        </div>
                    </div>
                </div>
                <div class="form-text mt-2">
                    <i class="bi bi-info-circle"></i> Override the default AI model for this import session. Leave unchanged to use system defaults.
                </div>
            </div>
        </div>

        <!-- Drop Zone -->
        <div id="invoice-import-container" data-llm-config-url="{% static 'llm_models.json' %}" data-batch-import-url="{% url 'invoice-batch-import' %}" data-current-provider="{{ current_provider }}" data-current-model="{{ current_model }}">
        <div class="drop-zone" id="dropZone">
            <div class="drop-zone-icon">
                <i class="bi bi-cloud-upload"></i>
            </div>
            <h4>Drag & Drop Invoice Files Here</h4>
            <p class="text-muted">or click to browse</p>
            <p class="text-muted small">
                Supported formats: {{ supported_formats|join:", " }}
            </p>
            <input type="file"
                   id="fileInput"
                   class="file-input"
                   multiple
                   accept=".pdf,.xlsx,.xls,.docx,.doc">
        </div>

        <!-- File List -->
        <div class="file-list" id="fileList" style="display: none;">
            <h4>Files to Import</h4>

            <!-- Progress Message -->
            <div class="progress-message" id="progressMessage">
                <strong id="progressText">Preparing to import...</strong>
            </div>

            <div id="fileItems"></div>
            <div class="mt-3">
                <button id="importBtn" class="btn btn-primary btn-lg">
                    <i class="bi bi-upload"></i> Import All Files
                </button>
                <button id="clearBtn" class="btn btn-secondary btn-lg ms-2">
                    <i class="bi bi-x-circle"></i> Clear All
                </button>
            </div>
        </div>

        <!-- Results Summary -->
        <div class="results-summary" id="resultsSummary" style="display: none;">
            <h4>Import Results</h4>
            <div class="row">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-primary" id="totalCount">0</h3>
                            <p class="mb-0">Total Files</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-success" id="importedCount">0</h3>
                            <p class="mb-0">Imported</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-warning" id="duplicateCount">0</h3>
                            <p class="mb-0">Duplicates</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-danger" id="errorCount">0</h3>
                            <p class="mb-0">Errors</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div id="resultsTable" style="display: none; margin-top: 30px;">
            <h4>Detailed Results</h4>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Status</th>
                            <th>Customer</th>
                            <th>Invoice No.</th>
                            <th>Amount</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/invoices/invoice_import.js' %}" defer></script>

{% csrf_token %}
{% endblock %}
