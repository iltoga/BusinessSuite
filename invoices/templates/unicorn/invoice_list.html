{% load unicorn %}
{% load check_perms %}
{% load filters %}

<div>
    <div class="centered-content">
        <h2>Invoice List</h2>

        <div class="col mb-2 p-2">
            <!-- Search form -->
            {% include 'components/list_search_form.html' with placeholder='Search Invoices...' %}
            {% if user|has_perm:'invoices,invoice,add' %}
            <a href="{% url 'invoice-create' %}" class="btn btn-primary">New invoice</a>
            {% endif %}
            {% if user.is_superuser %}
            <button type="button" class="btn btn-danger ms-2" data-bs-toggle="modal" data-bs-target="#deleteAllInvoicesModal">
                <i class="bi bi-trash3"></i> Delete All Invoices
            </button>
            {% endif %}
        </div>
    </div>

    <div class="justify-content-center table-responsive">
        {% if list_items %}
        <table class="table table-bordered table-condensed">
            <thead class="thead-light">
            <tr>
                <th scope="col">Invoice No</th>
                <th scope="col">Invoice Date</th>
                <th scope="col">Full Name</th>
                <th scope="col">Items</th>
                <th scope="col">Email</th>
                <th scope="col">Due Date</th>
                <th scope="col">Status</th>
                <th scope="col">Amount</th>
                <th scope="col">Paid</th>
                <th scope="col">Due</th>
                <th scope="col">Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for invoice in list_items %}
                <div class="list_row">
                    <tr class="{% if invoice.is_expired %}invoice-expired{% endif %}">
                        <!-- invoice no -->
                        <td>{{ invoice.invoice_no_display }}</td>
                        <!-- due date -->
                        <td>{{ invoice.due_date }}</td>
                        <!-- customer full name -->
                        <td>
                            <a href="{% url 'customer-detail' invoice.customer.pk %}" class="text-primary font-weight-light">{{ invoice.customer }}</a>
                        </td>
                        <!-- Items: customer applications -->
                        <td class="font-sm">
                            <ul>
                                {% for item in invoice.prefetched_invoice_applications %}
                                    <li>
                                        <a href="{% url 'customer-application-detail' item.customer_application.pk %}" class="text-primary font-weight-light">
                                            {{ item.customer_application.product.code }} - {% if item.customer_application.notes %}{{ item.customer_application.notes }}{% else %}{{ item.customer_application.customer.full_name }}{% endif %}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </td>
                        <!-- customer email -->
                        <td>
                        {% if invoice.customer.email %}
                            <a href="mailto:{{ invoice.customer.email }}" target="_blank">{{ invoice.customer.email }}</a>
                        {% endif %}
                        </td>
                        <!-- invoice date -->
                        <td>{{ invoice.invoice_date }}</td>
                        <!-- invoice status -->
                        <td>{% include "components/model_invoice_status_badge.html" with status=invoice.status status_display=invoice.get_status_display %}</td>
                        <!-- invoice amount -->
                        <td>{{ invoice.total_amount|as_currency }}</td>
                        <!-- invoice paid amount -->
                        <td>{{ invoice.total_paid|as_currency }}</td>
                        <!-- invoice due amount -->
                        <td>{{ invoice.total_due|as_currency }}</td>
                        <!-- actions -->
                        <td>
                        <div class="btn-group" role="group" aria-label="Basic example">
                            {% if user|has_perm:'invoices,invoice,view' %}
                            <a href="{% url 'invoice-detail' invoice.pk %}" class="btn btn-primary btn-sm me-1">View</a>
                            {% endif %}
                            {% if user|has_perm:'invoices,invoice,change' %}
                            <a href="{% url 'invoice-update' invoice.pk %}" class="btn btn-warning btn-sm me-1">Edit</a>
                            <div class="btn-group me-1">
                              <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                Download
                              </button>
                              <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{% url 'invoice-download' invoice.pk %}?format=docx">Download DOCX</a></li>
                                <li><a class="dropdown-item" href="{% url 'invoice-download' invoice.pk %}?format=pdf">Download PDF</a></li>
                              </ul>
                            </div>
                            {% endif %}
                            {% if user|has_perm:'payments,payment,add' and invoice.total_due > 0 %}
                            <button type="button" class="btn btn-success btn-sm me-1" data-bs-toggle="modal" data-bs-target="#markAsPaidModal{{ invoice.pk }}">Paid</button>
                            {% endif %}
                            {% if user.is_superuser %}
                            <a href="{% url 'invoice-delete' invoice.pk %}" class="btn btn-danger btn-sm me-1" title="Force Delete (Superuser only)">Delete</a>
                            {% endif %}
                        </div>
                        </td>
                    </tr>
                </div>
            {% endfor %}
            </tbody>
        </table>

        <div class="d-flex justify-content-center my-3">
            {% include 'components/list_pagination_buttons.html' %}
        </div>
        {% else %}
        <p>No Invoices found.</p>
        {% endif %}
    </div>

    <!-- Mark as Paid Modals (one for each invoice) -->
    {% for invoice in list_items %}
    <div class="modal fade" id="markAsPaidModal{{ invoice.pk }}" tabindex="-1" aria-labelledby="markAsPaidModalLabel{{ invoice.pk }}" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="markAsPaidModalLabel{{ invoice.pk }}">Mark Invoice {{ invoice.invoice_no_display }} as Paid</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form method="post" action="{% url 'invoice-mark-as-paid' invoice.pk %}">
            {% csrf_token %}
            <div class="modal-body">
              <p class="text-muted">This will create payments for all unpaid invoice applications.</p>

              <div class="mb-3">
                <label for="payment_type_{{ invoice.pk }}" class="form-label">Payment Method *</label>
                <select name="payment_type" id="payment_type_{{ invoice.pk }}" class="form-select" required>
                  <option value="cash">Cash</option>
                  <option value="credit_card">Credit card</option>
                  <option value="wire_transfer">Wire transfer</option>
                  <option value="crypto">Crypto</option>
                  <option value="paypal">PayPal</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="payment_date_{{ invoice.pk }}" class="form-label">Payment Date *</label>
                <input type="date" name="payment_date" id="payment_date_{{ invoice.pk }}" class="form-control" required value="{{ today|date:'Y-m-d' }}">
              </div>

              <h6 class="mt-4 mb-3">Items to be paid:</h6>
              <div class="table-responsive">
                <table class="table table-sm table-bordered">
                  <thead>
                    <tr>
                      <th>Application</th>
                      <th>Product</th>
                      <th class="text-end">Due Amount</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for app in invoice.prefetched_invoice_applications %}
                      {% if app.due_amount > 0 %}
                      <tr>
                        <td>{{ app.customer_application }}</td>
                        <td>{{ app.customer_application.product }}</td>
                        <td class="text-end">{{ app.due_amount|as_currency }}</td>
                      </tr>
                      {% endif %}
                    {% endfor %}
                  </tbody>
                  <tfoot>
                    <tr class="fw-bold">
                      <td colspan="2" class="text-end">Total:</td>
                      <td class="text-end">{{ invoice.total_due|as_currency }}</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Create Payments</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}

    <!-- Delete All Invoices Modal (Superuser only) -->
    {% if user.is_superuser %}
    <div class="modal fade" id="deleteAllInvoicesModal" tabindex="-1" aria-labelledby="deleteAllInvoicesModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="deleteAllInvoicesModalLabel">
              <i class="bi bi-exclamation-triangle"></i> Delete All Invoices
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form method="post" action="{% url 'invoice-delete-all' %}">
            {% csrf_token %}
            <div class="modal-body">
              <div class="alert alert-danger">
                <strong>Warning!</strong> This action cannot be undone.
              </div>
              <p>Are you sure you want to delete <strong>ALL</strong> invoices?</p>
              <p class="text-muted">This will permanently remove all invoice records from the database.</p>
              <div class="form-check mt-3">
                <input class="form-check-input" type="checkbox" value="yes" id="deleteCustomerApplications" name="delete_customer_applications">
                <label class="form-check-label" for="deleteCustomerApplications">
                  Also delete all corresponding customer applications (DocApplication) linked to the deleted invoices
                </label>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger">
                <i class="bi bi-trash3"></i> Yes, Delete All Invoices
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
</div>
