{% extends "base_template.html" %}
{% load crispy_forms_tags %}
{% load filters %}

{% block title %}BusinessSuite - {{ action_name }} payment{% endblock %}

{% block content %}
<div>
    <h2 class="text-center my-4">{{ action_name }} a new payment</h2>
    {% if form.non_field_errors %}
    <div class="alert alert-danger" role="alert">
        {{ form.non_field_errors }}
    </div>
    {% endif %}
    <form method="post" class="p-3 rounded w-100" action="{{ action }}" id="payment-form">
        {% csrf_token %}
        {% for field in form %}
            {{ field | as_crispy_field }}
        {% endfor %}
        {% if invoice_application %}
        <div class="mt-3" id="due-amount-display">Due Amount: {{invoice_application.due_amount|as_currency}}</div>
        {% else %}
        <div class="mt-3" id="due-amount-display" style="display: none;">Due Amount: <span id="due-amount-value"></span></div>
        {% endif %}

        <div>
            <hr \>
            <button type="submit" class="btn btn-primary">{{ action_name }}</button>
            <a href="javascript:history.back()" class="btn btn-outline-primary">Back</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const invoiceAppSelect = document.querySelector('#id_invoice_application');
    const amountInput = document.querySelector('#id_amount');
    const dueAmountDisplay = document.querySelector('#due-amount-display');
    const dueAmountValue = document.querySelector('#due-amount-value');

    // Get CSRF token from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    if (invoiceAppSelect && amountInput) {
        invoiceAppSelect.addEventListener('change', function() {
            const selectedId = this.value;
            if (selectedId) {
                const csrftoken = getCookie('csrftoken');

                // Fetch the due amount via AJAX
                fetch(`/api/invoices/get_invoice_application_due_amount/${selectedId}/`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrftoken
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.due_amount !== undefined) {
                        amountInput.value = data.due_amount;
                        if (dueAmountValue) {
                            dueAmountValue.textContent = new Intl.NumberFormat('id-ID', {
                                style: 'currency',
                                currency: 'IDR'
                            }).format(data.due_amount);
                            dueAmountDisplay.style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching due amount:', error);
                    alert('Failed to fetch invoice amount. Please try again.');
                });
            } else {
                amountInput.value = '';
                if (dueAmountDisplay && !{{ invoice_application|yesno:"true,false" }}) {
                    dueAmountDisplay.style.display = 'none';
                }
            }
        });
    }
});
</script>
{% endblock %}
