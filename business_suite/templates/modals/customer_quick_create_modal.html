{% load crispy_forms_tags %}

<style>
    #customerQuickCreateModal {
        z-index: 1050;
    }

    #customerQuickCreateModal + .modal-backdrop {
        z-index: 1049;
    }
</style>

<!-- Customer Quick Create Modal -->
<div class="modal fade" id="customerQuickCreateModal" tabindex="-1" aria-labelledby="customerQuickCreateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="customerQuickCreateModalLabel">
                    <i class="fas fa-user-plus"></i> Quick Create Customer
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="customerQuickCreateForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Fill in the required fields to quickly create a new customer.
                    </div>
                    <div id="customerQuickCreateErrors" class="alert alert-danger d-none"></div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_quick_title" class="form-label">Title</label>
                            <select class="form-select" id="id_quick_title" name="title">
                                <option value="">---------</option>
                                <option value="Mr">Mr</option>
                                <option value="Mrs">Mrs</option>
                                <option value="Ms">Ms</option>
                                <option value="Miss">Miss</option>
                                <option value="Dr">Dr</option>
                                <option value="Prof">Prof</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="id_quick_gender" class="form-label">Gender</label>
                            <select class="form-select" id="id_quick_gender" name="gender">
                                <option value="">---------</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_quick_first_name" class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="id_quick_first_name" name="first_name" required pattern="[A-Z][a-zA-Z\s]*" title="First letter must be uppercase">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="id_quick_last_name" class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="id_quick_last_name" name="last_name" required>
                        </div>
                    </div>


                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_quick_telephone" class="form-label">Telephone <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="id_quick_telephone" name="telephone" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="id_quick_whatsapp" class="form-label">WhatsApp</label>
                            <input type="tel" class="form-control" id="id_quick_whatsapp" name="whatsapp">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="id_quick_email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="id_quick_email" name="email">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_quick_birthdate" class="form-label">Birthdate</label>
                            <input type="date" class="form-control" id="id_quick_birthdate" name="birthdate">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="id_quick_nationality" class="form-label">Nationality</label>
                            <select class="form-select" id="id_quick_nationality" name="nationality">
                                <option value="">---------</option>
                                {% for country in countries %}
                                <option value="{{ country.alpha3_code }}">{{ country.country }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="customerQuickCreateSubmitBtn">
                        <i class="fas fa-save"></i> Create Customer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Customer Quick Create Modal Handler
    (function() {
        var $modal = $('#customerQuickCreateModal');
        var $form = $('#customerQuickCreateForm');
        var $submitBtn = $('#customerQuickCreateSubmitBtn');
        var $errors = $('#customerQuickCreateErrors');
        var targetSelectId = null; // Will store the ID of the select element to update

        // Initialize select2 for nationality - but only once
        var select2Initialized = false;

        // Store target select when modal is opened
        window.openCustomerQuickCreateModal = function(selectElementId) {
            targetSelectId = selectElementId;
            $form[0].reset();
            $errors.addClass('d-none').html('');

            // Initialize select2 only on first open
            if (!select2Initialized) {
                console.log('Initializing select2 on modal open, options count:', $('#id_quick_nationality option').length);
                $('#id_quick_nationality').select2({
                    theme: 'bootstrap-5',
                    dropdownParent: $modal,
                    placeholder: 'Select nationality',
                    allowClear: false,
                    width: '100%',
                });
                select2Initialized = true;
                console.log('After select2 init, select2 data:', $('#id_quick_nationality').select2('data'));
            }

            $('#id_quick_nationality').val('').trigger('change');
            $modal.modal('show');
        };

        // Handle form submission
        $form.on('submit', function(e) {
            e.preventDefault();
            $errors.addClass('d-none').html('');
            $submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Creating...');

            $.ajax({
                url: '{% url "api-customer-quick-create" %}',
                method: 'POST',
                data: $form.serialize(),
                headers: {
                    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]', $form).val()
                },
                success: function(response) {
                    if (response.success) {
                        // Add new customer to target select
                        if (targetSelectId) {
                            var $targetSelect = $('#' + targetSelectId);
                            var newOption = new Option(
                                response.customer.full_name,
                                response.customer.id,
                                true,
                                true
                            );
                            $targetSelect.append(newOption).trigger('change');
                        }

                        // Close modal and reset form
                        $modal.modal('hide');
                        $form[0].reset();

                        // Show success message
                        if (typeof showSuccessToast === 'function') {
                            showSuccessToast('Customer created successfully!');
                        } else {
                            alert('Customer created successfully!');
                        }
                    } else {
                        // Show errors
                        var errorHtml = '<ul class="mb-0">';
                        $.each(response.errors, function(field, errors) {
                            $.each(errors, function(i, error) {
                                errorHtml += '<li>' + error + '</li>';
                            });
                        });
                        errorHtml += '</ul>';
                        $errors.html('<strong>An error occurred while creating the customer:</strong> ' + errorHtml).removeClass('d-none');
                    }
                },
                error: function(xhr) {
                    var errorMsg = 'An error occurred while creating the customer.';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    $errors.html(errorMsg).removeClass('d-none');
                },
                complete: function() {
                    $submitBtn.prop('disabled', false).html('<i class="fas fa-save"></i> Create Customer');
                }
            });
        });

        // Reset form when modal is hidden
        $modal.on('hidden.bs.modal', function() {
            $form[0].reset();
            $errors.addClass('d-none').html('');
            $('#id_quick_nationality').val('').trigger('change');
            targetSelectId = null;
        });
    })();
</script>
