{% extends "reports/base_report.html" %}
{% load static %}
{% load humanize %}
{% load report_filters %}

{% block report_title %}Revenue Report{% endblock %}
{% block report_heading %}Revenue Report{% endblock %}
{% block report_description %}Monthly and yearly revenue analysis from invoices and payments{% endblock %}

{% block report_filters %}
<div class="report-filters no-print">
    <form method="get" class="row g-3">
        <div class="col-md-4">
            <label for="from_date" class="form-label">From Date</label>
            <input type="date" class="form-control" id="from_date" name="from_date" value="{{ from_date }}">
        </div>
        <div class="col-md-4">
            <label for="to_date" class="form-label">To Date</label>
            <input type="date" class="form-control" id="to_date" name="to_date" value="{{ to_date }}">
        </div>
        <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-funnel"></i> Filter
            </button>
            <a href="{% url 'report-revenue' %}" class="btn btn-secondary ms-2">Reset</a>
        </div>
    </form>
</div>
{% endblock %}

{% block report_content %}
<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="stat-label">Total Invoiced</div>
                <div class="stat-value">{{ total_invoiced_formatted }}</div>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card stat-card" style="border-left-color: #198754;">
            <div class="card-body">
                <div class="stat-label">Total Collected</div>
                <div class="stat-value" style="color: #198754;">{{ total_paid_formatted }}</div>
                <div class="mt-2">
                    <small class="text-muted">Collection Rate: {{ collection_rate|floatformat:1 }}%</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card stat-card" style="border-left-color: #ffc107;">
            <div class="card-body">
                <div class="stat-label">Outstanding</div>
                <div class="stat-value" style="color: #ffc107;">{{ total_outstanding_formatted }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Revenue Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Monthly Revenue Comparison</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Data Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Monthly Breakdown</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th class="text-end">Invoiced</th>
                                <th class="text-end">Collected</th>
                                <th class="text-end">Outstanding</th>
                                <th class="text-end">Collection Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for month in monthly_revenue %}
                            <tr>
                                <td>{{ month.label }}</td>
                                <td class="text-end">{{ CURRENCY_SYMBOL }} {{ month.invoiced|floatformat:0|intcomma }}</td>
                                <td class="text-end">{{ CURRENCY_SYMBOL }} {{ month.paid|floatformat:0|intcomma }}</td>
                                <td class="text-end">{{ CURRENCY_SYMBOL }} {{ month.invoiced|add:month.paid|floatformat:0|intcomma }}</td>
                                <td class="text-end">
                                    {% widthratio month.paid month.invoiced 100 %}%
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% if yoy_data %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Year-over-Year Comparison</h5>
            </div>
            <div class="card-body">
                <p>Previous Year: {{ CURRENCY_SYMBOL }} {{ yoy_data.previous_year|floatformat:0|intcomma }}</p>
                <p>Current Year: {{ CURRENCY_SYMBOL }} {{ yoy_data.current_year|floatformat:0|intcomma }}</p>
                <p class="{% if yoy_data.change_percent > 0 %}trend-up{% else %}trend-down{% endif %}">
                    Change: {{ yoy_data.change_percent|floatformat:1 }}%
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block report_charts %}
<script>
    const revenueData = {{ monthly_revenue|to_json }};

    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const revenueChart = new Chart(revenueCtx, {
        type: 'bar',
        data: {
            labels: revenueData.map(d => d.label),
            datasets: [{
                label: 'Invoiced',
                data: revenueData.map(d => d.invoiced),
                backgroundColor: 'rgba(13, 110, 253, 0.7)',
            }, {
                label: 'Collected',
                data: revenueData.map(d => d.paid),
                backgroundColor: 'rgba(25, 135, 84, 0.7)',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '{{ CURRENCY_SYMBOL }} ' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': {{ CURRENCY_SYMBOL }} ' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
