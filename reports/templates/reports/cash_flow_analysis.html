{% extends "reports/base_report.html" %}
{% load static %}
{% load humanize %}
{% load report_filters %}

{% block report_title %}Cash Flow Analysis{% endblock %}
{% block report_heading %}Cash Flow Analysis{% endblock %}
{% block report_description %}Payment tracking by type and date{% endblock %}

{% block report_filters %}
<div class="report-filters no-print">
    <form method="get" class="row g-3">
        <div class="col-md-4">
            <label for="from_date" class="form-label">From Date</label>
            <input type="date" class="form-control" id="from_date" name="from_date" value="{{ from_date }}">
        </div>
        <div class="col-md-4">
            <label for="to_date" class="form-label">To Date</label>
            <input type="date" class="form-control" id="to_date" name="to_date" value="{{ to_date }}">
        </div>
        <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-funnel"></i> Filter
            </button>
            <a href="{% url 'report-cash-flow' %}" class="btn btn-secondary ms-2">Reset</a>
        </div>
    </form>
</div>
{% endblock %}

{% block report_content %}
<!-- Summary Stats -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="stat-label">Total Cash Flow</div>
                <div class="stat-value">{{ total_cashflow_formatted }}</div>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="stat-label">Avg Monthly</div>
                <div class="stat-value">{{ avg_monthly_cashflow_formatted }}</div>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="stat-label">Total Transactions</div>
                <div class="stat-value">{{ total_transactions }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row mb-4">
    <div class="col-lg-8 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Monthly Cash Flow</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="cashflowChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Payment Types</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 350px;">
                    <canvas id="paymentTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Type Breakdown Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Payment Type Breakdown</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Payment Type</th>
                                <th class="text-end">Count</th>
                                <th class="text-end">Total Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment_type in payment_type_data %}
                            <tr>
                                <td><span class="badge bg-secondary">{{ payment_type.type }}</span></td>
                                <td class="text-end">{{ payment_type.count }}</td>
                                <td class="text-end">{{ payment_type.total_formatted }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block report_charts %}
<script>
    const monthlyData = {{ monthly_cashflow|to_json }};
    const paymentTypeData = {{ payment_type_data|to_json }};

    // Monthly Cashflow Chart
    const cashflowCtx = document.getElementById('cashflowChart').getContext('2d');
    new Chart(cashflowCtx, {
        type: 'line',
        data: {
            labels: monthlyData.map(d => d.label),
            datasets: [{
                label: 'Cash Flow',
                data: monthlyData.map(d => d.total),
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Payment Type Chart
    const paymentTypeCtx = document.getElementById('paymentTypeChart').getContext('2d');
    new Chart(paymentTypeCtx, {
        type: 'pie',
        data: {
            labels: paymentTypeData.map(d => d.type),
            datasets: [{
                data: paymentTypeData.map(d => d.total),
                backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6c757d']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
</script>
{% endblock %}
