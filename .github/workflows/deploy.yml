name: Deploy BusinessSuite to VPS using SSH and GitHub Actions

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-businesssuite
      cancel-in-progress: true
    env:
      DOCKER_BUILDKIT: 1

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 30m
          command_timeout: 30m
          script: |
            set -e
            REPO_DIR="${{ secrets.REPO_DIR }}"

            # Making space for new deployment
            docker system prune -f

            echo "üöÄ  Starting deployment ‚Ä¶"
            echo "üìÅ  Repository directory: $REPO_DIR"

            if [ ! -d "$REPO_DIR" ]; then
              echo "‚ùå  Repository directory does not exist, aborting."
              exit 1
            fi

            cd "$REPO_DIR"
            echo "üìÇ  Working directory: $(pwd)"

            echo "üîó  Ensuring correct Git remote ‚Ä¶"
            git remote set-url origin git@github.com:iltoga/BusinessSuite.git

            OLD_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo none)
            echo "üìä  Current commit: $OLD_COMMIT"

            echo "üì•  Fetching latest changes ‚Ä¶"
            git fetch --all

            echo "üîÑ  Switching to main branch ‚Ä¶"
            git checkout main

            echo "üê≥  Stopping all existing containers..."
            # Stop containers managed by compose
            docker compose down --remove-orphans || echo "‚ö†Ô∏è  No compose containers to stop"

            # Force remove any containers that might be lingering
            docker ps -a -q --filter "name=postgres-srv" | xargs -r docker rm -f || true
            docker ps -a -q --filter "name=pgadmin" | xargs -r docker rm -f || true
            docker ps -a -q --filter "name=bs-core" | xargs -r docker rm -f || true
            docker ps -a -q --filter "name=bs-worker" | xargs -r docker rm -f || true
            docker ps -a -q --filter "name=memcached" | xargs -r docker rm -f || true
            docker ps -a -q --filter "name=crmrevisbalicom" | xargs -r docker rm -f || true
            echo "‚úÖ  All containers removed"

            echo "üßπ  Resetting local state ‚Ä¶"
            git reset --hard origin/main

            # Safely clean only untracked files that won't interfere with operations
            echo "üßπ  Cleaning safe untracked files..."
            git clean -f || echo "‚ö†Ô∏è  Some files couldn't be cleaned, continuing..."

            echo "‚¨áÔ∏è  Pulling latest commits ‚Ä¶"
            git pull origin main

            NEW_COMMIT=$(git rev-parse HEAD)
            echo "üìä  New commit: $NEW_COMMIT"

            echo "üîç  Detecting dependency-file changes ‚Ä¶"
            DEP_CHANGED=false
            if [ "$OLD_COMMIT" != none ] && [ "$OLD_COMMIT" != "$NEW_COMMIT" ]; then
              if git diff --name-only $OLD_COMMIT $NEW_COMMIT | grep -E '(backend/pyproject\.toml|backend/requirements\.txt|Dockerfile|Dockerfile\.frontend|frontend/|backend/locale/|.*\\.po$)' >/dev/null; then
                DEP_CHANGED=true
                echo "üì¶  Dependencies or Dockerfile changed ‚Äî full rebuild needed."
              else
                echo "üì¶  No dependency/Dockerfile change ‚Äî cached dependencies will be reused."
              fi
            fi

            echo "‚öôÔ∏è  Exporting environment variables from .env ‚Ä¶"
            if [ -f .env ]; then
              set -a
              source .env
              set +a
              echo "‚úÖ  .env variables loaded."
            else
              echo "‚ùå  .env not found, aborting."
              exit 1
            fi

            export GIT_COMMIT_SHA="$NEW_COMMIT"
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1

            echo "ÔøΩÔ∏è  Building and starting containers ‚Ä¶"
            if [ "$DEP_CHANGED" = true ]; then
              docker compose build --pull
            fi
            docker compose up -d --remove-orphans bs-core bs-worker bs-frontend

            # Optionally run initial data seeding if explicitly requested via .env (INITIALIZE_DB=true)
            if [ "${INITIALIZE_DB:-false}" = "true" ]; then
              echo "üß™  INITIALIZE_DB=true ‚Äî running one-off seeding script inside bs-core container via exec with retries"

              # Try to execute the init script inside the running bs-core container.
              # Use `exec` to avoid creating a second container that could conflict on ports.
              ATTEMPTS=0
              MAX_ATTEMPTS=6
              SLEEP_SECONDS=10
              until docker compose exec -T bs-core /bin/bash /usr/src/app/scripts/init_db.sh; do
                ATTEMPTS=$((ATTEMPTS + 1))
                if [ "$ATTEMPTS" -ge "$MAX_ATTEMPTS" ]; then
                  echo "‚ùå Failed to run init script after $ATTEMPTS attempts. Aborting."
                  exit 1
                fi
                echo "‚ö†Ô∏è bs-core not ready for exec (attempt $ATTEMPTS/$MAX_ATTEMPTS), retrying in ${SLEEP_SECONDS}s..."
                sleep "$SLEEP_SECONDS"
              done

              echo "‚úÖ INIT script completed."
            else
              echo "‚ÑπÔ∏è  INITIALIZE_DB != true ‚Äî skipping one-off seeding tasks"
            fi

            echo "üßπ  Cleaning up unused data ‚Ä¶"
            docker system prune -f
