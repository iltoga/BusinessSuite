name: Deploy BusinessSuite to VPS using SSH and GitHub Actions

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-businesssuite
      cancel-in-progress: true
    env:
      DOCKER_BUILDKIT: 1

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 30m
          command_timeout: 30m
          script: |
            set -e
            REPO_DIR="${{ secrets.REPO_DIR }}"

            # Making space for new deployment
            docker system prune -f

            echo "ğŸš€  Starting deployment â€¦"
            echo "ğŸ“  Repository directory: $REPO_DIR"

            if [ ! -d "$REPO_DIR" ]; then
              echo "âŒ  Repository directory does not exist, aborting."
              exit 1
            fi

            cd "$REPO_DIR"
            echo "ğŸ“‚  Working directory: $(pwd)"

            echo "ğŸ”—  Ensuring correct Git remote â€¦"
            git remote set-url origin git@github.com:iltoga/BusinessSuite.git

            OLD_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo none)
            echo "ğŸ“Š  Current commit: $OLD_COMMIT"

            echo "ğŸ“¥  Fetching latest changes â€¦"
            git fetch --all

            echo "ğŸ”„  Switching to main branch â€¦"
            git checkout main

            echo "ğŸ³  Stopping all existing containers..."
            # Stop containers managed by compose
            docker compose down --remove-orphans || echo "âš ï¸  No compose containers to stop"

            # Force remove any containers that might be lingering
            docker ps -a -q --filter "name=postgres-srv" | xargs -r docker rm -f || true
            docker ps -a -q --filter "name=pgadmin" | xargs -r docker rm -f || true
            docker ps -a -q --filter "name=bs-core" | xargs -r docker rm -f || true
            docker ps -a -q --filter "name=bs-worker" | xargs -r docker rm -f || true
            docker ps -a -q --filter "name=memcached" | xargs -r docker rm -f || true
            docker ps -a -q --filter "name=crmrevisbalicom" | xargs -r docker rm -f || true
            echo "âœ…  All containers removed"

            echo "ğŸ§¹  Resetting local state â€¦"
            git reset --hard origin/main

            # Safely clean only untracked files that won't interfere with operations
            echo "ğŸ§¹  Cleaning safe untracked files..."
            git clean -f || echo "âš ï¸  Some files couldn't be cleaned, continuing..."

            echo "â¬‡ï¸  Pulling latest commits â€¦"
            git pull origin main

            NEW_COMMIT=$(git rev-parse HEAD)
            echo "ğŸ“Š  New commit: $NEW_COMMIT"

            echo "ğŸ”  Detecting dependency-file changes â€¦"
            DEP_CHANGED=false
            if [ "$OLD_COMMIT" != none ] && [ "$OLD_COMMIT" != "$NEW_COMMIT" ]; then
              if git diff --name-only $OLD_COMMIT $NEW_COMMIT | grep -E '(pyproject\.toml|requirements\.txt|Dockerfile|Dockerfile\.frontend|frontend/|locale/|.*\\.po$)' >/dev/null; then
                DEP_CHANGED=true
                echo "ğŸ“¦  Dependencies or Dockerfile changed â€” full rebuild needed."
              else
                echo "ğŸ“¦  No dependency/Dockerfile change â€” cached dependencies will be reused."
              fi
            fi

            echo "âš™ï¸  Exporting environment variables from .env â€¦"
            if [ -f .env ]; then
              set -a
              source .env
              set +a
              echo "âœ…  .env variables loaded."
            else
              echo "âŒ  .env not found, aborting."
              exit 1
            fi

            export GIT_COMMIT_SHA="$NEW_COMMIT"
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1

            echo "ğŸ› ï¸  Building and starting containers â€¦"
            if [ "$DEP_CHANGED" = true ]; then
              docker compose build --pull
            fi
            docker compose up -d --remove-orphans bs-core bs-worker bs-frontend

            echo "ğŸ§¹  Cleaning up unused data â€¦"
            docker system prune -f
