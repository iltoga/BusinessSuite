{% extends "base_template.html" %}
{% load static %}

{% block content %}
<h1>Restore Database</h1>

<div class="mb-4">
  <h3>Option 1: Restore from Existing Backup</h3>
  <div class="mb-3">
    <label for="backup-select" class="form-label">Choose backup:</label>
    <select id="backup-select" class="form-select" {% if not backups %}disabled{% endif %}>
      {% for b in backups %}
        <option value="{{ b.filename }}">{{ b.filename }} - {% if b.size %}{{ b.size|filesizeformat }}{% else %}unknown{% endif %} - {{ b.type }}{% if b.included_files %} - {{ b.included_files }} files{% endif %}</option>
      {% empty %}
        <option value="">No backups available</option>
      {% endfor %}
    </select>
  </div>
  <div class="mb-2">
    <input type="checkbox" id="include-users" name="include-users">
    <label for="include-users">Include users/groups/permissions (full restore)</label>
  </div>
  <button id="start-restore" class="btn btn-danger" {% if not backups %}disabled{% endif %} data-restore-url="{% url 'admin_tools:restore_start' %}">Start Restore from Existing Backup</button>
</div>

<hr class="my-4">

<div class="mb-4">
  <h3>Option 2: Upload and Restore from File</h3>
  <form id="upload-form" enctype="multipart/form-data" data-upload-url="{% url 'admin_tools:upload_backup' %}">
    {% csrf_token %}
    <div class="mb-3">
      <label for="backup-file" class="form-label">Choose backup file (.json, .json.gz, .tar.gz, or .tgz):</label>
      <input type="file" class="form-control" id="backup-file" name="backup_file" accept=".json,.gz,.tar.gz,.tgz" required>
    </div>
    <div id="upload-progress-container" class="mb-3 d-none">
      <div class="progress mb-2">
        <div id="upload-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <small id="upload-status" class="text-muted">Preparing...</small>
        <button type="button" id="cancel-upload" class="btn btn-sm btn-outline-danger">Cancel Upload</button>
      </div>
    </div>
    <button type="submit" class="btn btn-warning" id="upload-restore-btn">Upload and Restore</button>
  </form>
</div>

<h3>Live log</h3>
<div id="restore-progress-container" class="mb-3 d-none">
  <div class="progress mb-2">
    <div id="restore-progress-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
  </div>
</div>
<pre id="log" style="background:#111;color:#eee;padding:1rem;max-height:300px;overflow:auto;"></pre>

{% endblock %}

{% block after-bootstrap-js %}
  {{ block.super }}
  <script src="{% static 'js/admin_tools/restore.js' %}"></script>
{% endblock %}
