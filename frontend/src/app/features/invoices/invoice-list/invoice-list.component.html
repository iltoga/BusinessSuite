<div class="h-full flex flex-col gap-6" [contextHelp]="'/invoices'">
  <div class="flex flex-wrap items-start justify-between gap-3">
    <h1 class="text-2xl font-bold tracking-tight sm:text-3xl">Invoices</h1>
    <div class="flex flex-wrap items-center gap-2">
      <a routerLink="/invoices/import">
        <z-button zType="secondary" zSize="default">Import Invoice</z-button>
      </a>
      <a
        routerLink="/invoices/new"
        [state]="{ from: 'invoices', searchQuery: query() }"
        [contextHelp]="'/invoices/new'"
      >
        <z-button zType="default" zSize="default">New Invoice</z-button>
      </a>
    </div>
  </div>

  <div class="bg-card rounded-lg border shadow-sm">
    <div class="border-b p-3 sm:p-4">
      <app-search-toolbar
        [query]="query()"
        [placeholder]="'Search invoices...'"
        (queryChange)="onQueryChange($event)"
        (tabOut)="dataTable.focusFirstRowIfNone()"
        [contextHelp]="'/invoices/search'"
      >
        <div class="flex w-full flex-wrap items-center gap-3 sm:w-auto">
          <div class="flex items-center gap-2">
            <input
              type="checkbox"
              id="hidePaid"
              [checked]="hidePaid()"
              (change)="onToggleHidePaid($event)"
              class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary cursor-pointer"
            />
            <label
              for="hidePaid"
              class="text-sm font-medium leading-none cursor-pointer select-none"
            >
              Hide Paid
            </label>
          </div>
          @if (isSuperuser() && totalItems() > 0) {
            <z-button
              zType="destructive"
              zSize="sm"
              (click)="openBulkDeleteDialog()"
              [contextHelp]="'/invoices/bulk-delete'"
            >
              {{ bulkDeleteLabel() }}
            </z-button>
          }
        </div>
      </app-search-toolbar>
    </div>

    <div class="p-0">
      <app-data-table
        #dataTable
        [columns]="columns()"
        [data]="invoices()"
        [actions]="actions()"
        [isLoading]="isLoading()"
        [currentPage]="page()"
        [totalPages]="totalPages()"
        (pageChange)="onPageChange($event)"
        (sortChange)="onSortChange($event)"
      />
    </div>

    <div class="border-t bg-muted/20 p-3 sm:p-4">
      <app-pagination-controls
        [page]="page()"
        [totalPages]="totalPages()"
        [totalItems]="totalItems()"
        (pageChange)="onPageChange($event)"
      />
    </div>
  </div>
</div>

<ng-template #numberTemplate let-row>
  <a
    [routerLink]="['/invoices', row.id]"
    [state]="{ from: 'invoices', focusId: row.id, searchQuery: query() }"
    class="font-medium hover:underline"
  >
    {{ row.invoiceNoDisplay || row.invoiceNo || '—' }}
  </a>
</ng-template>

<ng-template #customerTemplate let-row>
  <div class="flex flex-col">
    <span class="font-medium">{{
      row.customer?.fullNameWithCompany || row.customer?.fullName
    }}</span>
    <span class="text-xs text-muted-foreground">{{ row.customer?.email || '—' }}</span>
  </div>
</ng-template>

<ng-template #itemsTemplate let-row>
  <ul class="space-y-1 text-sm">
    @for (item of row.invoiceApplications ?? []; track item.id) {
      <li>
        {{ item.customerApplication?.product?.code }} -
        {{ item.customerApplication?.notes || item.customerApplication?.customer?.fullName || '—' }}
      </li>
    }
    @if (!row.invoiceApplications?.length) {
      <li class="text-muted-foreground">—</li>
    }
  </ul>
</ng-template>

<ng-template #dueTemplate let-row>
  <span>{{ row.dueDate ? (row.dueDate | appDate) : '—' }}</span>
</ng-template>

<ng-template #statusTemplate let-row>
  <z-badge [zType]="statusVariant(row.status)">{{ row.status || '—' }}</z-badge>
</ng-template>

<ng-template #amountsTemplate let-row>
  <div class="flex flex-col text-sm">
    <ng-container *ngIf="isFullyPaid(row); else partialTpl">
      <span class="font-medium">{{ formatCurrency(row.totalPaidAmount) }}</span>
    </ng-container>
    <ng-template #partialTpl>
      <span>Total: {{ formatCurrency(row.totalAmount) }}</span>
      <span>Paid: {{ formatCurrency(row.totalPaidAmount) }}</span>
      <span>Due: {{ formatCurrency(row.totalDueAmount) }}</span>
    </ng-template>
  </div>
</ng-template>

<ng-template #createdAtTemplate let-row>
  <div class="invoice-created-updated flex flex-col">
    <span class="invoice-created-updated__created">{{
      $any(row).createdAt ? ($any(row).createdAt | appDate: 'datetime') : ''
    }}</span>
    @if ($any(row).updatedAt && $any(row).updatedAt !== $any(row).createdAt) {
      <span class="invoice-created-updated__updated text-muted-foreground">{{
        $any(row).updatedAt ? ($any(row).updatedAt | appDate: 'datetime') : ''
      }}</span>
    }
  </div>
</ng-template>

<ng-template #actionsTemplate let-row>
  <div class="flex items-center gap-2">
    <app-invoice-download-dropdown
      [invoiceId]="row.id"
      [invoiceNumber]="(row.invoiceNoDisplay || row.invoiceNo || '—').toString()"
      [customerName]="row.customer?.fullNameWithCompany || row.customer?.fullName || '—'"
      zType="secondary"
      zSize="sm"
    />
    <div class="flex items-center justify-end">
      <button
        z-dropdown
        [zDropdownMenu]="rowActionsMenu"
        z-button
        zType="ghost"
        zSize="sm"
        type="button"
        class="h-8 w-8 p-0"
        tabindex="-1"
        (click)="$event.stopPropagation()"
        aria-label="Row actions"
        aria-haspopup="menu"
      >
        <z-icon zType="ellipsis-horizontal" />
      </button>
      <z-dropdown-menu-content #rowActionsMenu class="z-50 min-w-48">
        @for (action of actions(); track action.label) {
          @if (!action.isVisible || action.isVisible(row)) {
            <button
              z-dropdown-menu-item
              type="button"
              [variant]="action.variant ?? (action.isDestructive ? 'destructive' : 'default')"
              (click)="action.action(row); $event.stopPropagation()"
            >
              <z-icon [zType]="action.icon" class="mr-2 h-4 w-4 stroke-current" />
              <span [innerHTML]="action.label | shortcutHighlight"></span>
            </button>
          }
        }
      </z-dropdown-menu-content>
    </div>
  </div>
</ng-template>

<app-bulk-delete-dialog
  [isOpen]="bulkDeleteOpen()"
  [data]="bulkDeleteData()"
  (confirmed)="onBulkDeleteConfirmed($event)"
  (cancelled)="onBulkDeleteCancelled()"
/>

<app-invoice-delete-dialog
  [isOpen]="invoiceDeleteOpen()"
  [data]="invoiceDeleteData()"
  (confirmed)="onInvoiceDeleteConfirmed($event)"
  (cancelled)="onInvoiceDeleteCancelled()"
/>
