<div class="max-w-4xl mx-auto space-y-8">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <div class="space-y-1">
      <div class="flex items-center gap-2 text-muted-foreground mb-2">
        <a
          routerLink="/customers"
          class="flex items-center hover:text-foreground transition-colors"
        >
          <z-icon zType="arrow-left" class="h-4 w-4" />
          <span class="text-xs font-medium uppercase tracking-wider">Back to list</span>
        </a>
      </div>
      <h1 class="text-3xl font-extrabold tracking-tight">
        {{ isEditMode() ? 'Edit Customer' : 'New Customer' }}
      </h1>
      <p class="text-sm text-muted-foreground">Manage customer profile data.</p>
    </div>
  </div>

  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-6">
    <app-form-error-summary [form]="form" [labels]="formErrorLabels" />

    <!-- 1) Customer Type -->
    <z-card class="overflow-hidden">
      <div class="bg-accent/30 px-6 py-4 border-b">
        <h2 class="text-sm font-semibold uppercase tracking-wider flex items-center gap-2">
          <z-icon zType="users" class="h-4 w-4 text-primary" />
          1. Customer Type
        </h2>
      </div>
      <div class="p-6">
        <div class="space-y-2">
          <label class="text-sm font-medium">Type <span class="text-destructive">*</span></label>
          <div class="flex gap-6">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" formControlName="customer_type" value="person" class="w-4 h-4" />
              <span>Person</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" formControlName="customer_type" value="company" class="w-4 h-4" />
              <span>Company</span>
            </label>
          </div>
        </div>
      </div>
    </z-card>

    <!-- 2) Basic Information -->
    <z-card class="overflow-hidden">
      <div class="bg-accent/30 px-6 py-4 border-b">
        <h2 class="text-sm font-semibold uppercase tracking-wider flex items-center gap-2">
          <z-icon zType="user" class="h-4 w-4 text-primary" />
          2. Basic Information
        </h2>
      </div>
      <div class="p-6">
        <div class="grid gap-6 md:grid-cols-12">
          @if (isPerson()) {
            <div class="md:col-span-2 space-y-2">
              <label class="text-sm font-medium">Title</label>
              <select z-input formControlName="title" class="w-full">
                @for (option of titleOptions; track option.value) {
                  <option [value]="option.value">{{ option.label }}</option>
                }
              </select>
            </div>
            <div class="md:col-span-2 space-y-2">
              <label class="text-sm font-medium">Gender</label>
              <select z-input formControlName="gender" class="w-full">
                @for (option of genderOptions; track option.value) {
                  <option [value]="option.value">{{ option.label }}</option>
                }
              </select>
            </div>
            <div class="md:col-span-4 space-y-2">
              <label class="text-sm font-medium"
                >First Name <span class="text-destructive">*</span></label
              >
              <input
                z-input
                formControlName="first_name"
                placeholder="First name"
                (blur)="formatName('first_name')"
              />
              @if (form.get('first_name')?.touched || submitted()) {
                @if (form.get('first_name')?.hasError('required')) {
                  <p class="text-sm text-red-500">First name is required</p>
                } @else if (form.get('first_name')?.hasError('pattern')) {
                  <p class="text-sm text-red-500">
                    Must start with a capital letter (e.g. Stefano)
                  </p>
                }
              }
            </div>

            <div class="md:col-span-4 space-y-2">
              <label class="text-sm font-medium"
                >Last Name <span class="text-destructive">*</span></label
              >
              <input
                z-input
                formControlName="last_name"
                placeholder="Last name"
                (blur)="formatName('last_name')"
              />
              @if (form.get('last_name')?.touched || submitted()) {
                @if (form.get('last_name')?.hasError('required')) {
                  <p class="text-sm text-red-500">Last name is required</p>
                }
              }
            </div>
          } @else {
            <div class="md:col-span-12 space-y-2">
              <label class="text-sm font-medium"
                >Company Name <span class="text-destructive">*</span></label
              >
              <input z-input formControlName="company_name" placeholder="Company name" />
              @if (form.get('company_name')?.touched || submitted()) {
                @if (form.get('company_name')?.hasError('required')) {
                  <p class="text-sm text-red-500">Company name is required</p>
                }
              }
            </div>
          }
        </div>
      </div>
    </z-card>

    <!-- 3) Identification & Documents -->
    <z-card class="overflow-hidden">
      <div class="bg-accent/30 px-6 py-4 border-b">
        <h2 class="text-sm font-semibold uppercase tracking-wider flex items-center gap-2">
          <z-icon zType="file-text" class="h-4 w-4 text-primary" />
          3. Identification & Documents
        </h2>
      </div>
      <div class="p-6 space-y-4">
        <!-- Passport import area keeps same logic -->
        @if (isPerson()) {
          <div class="space-y-4 mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
              <div>
                <h4 class="text-base font-semibold">Import data from Passport</h4>
                <p class="text-sm text-muted-foreground">
                  Upload a passport image or PDF to auto-fill the form fields.
                </p>
              </div>
              <label class="flex items-center gap-2 text-sm">
                <input
                  type="checkbox"
                  class="h-4 w-4"
                  [checked]="ocrUseAi()"
                  (change)="onToggleUseAi($event)"
                />
                <span>Use AI-enhanced extraction</span>
              </label>
            </div>

            <app-file-upload
              [label]="'Passport file (image or PDF)'"
              [accept]="'image/*,application/pdf'"
              [disabled]="ocrProcessing()"
              [progress]="ocrProcessing() ? 10 : null"
              [fileName]="passportFile()?.name ?? null"
              [helperText]="'Supported: JPG, PNG, PDF'"
              (fileSelected)="onPassportFileSelected($event)"
              (cleared)="onPassportFileCleared()"
            ></app-file-upload>

            <div class="flex flex-wrap gap-3">
              <button
                type="button"
                z-button
                zType="default"
                [zDisabled]="ocrProcessing()"
                (click)="onPassportImport()"
              >
                {{ ocrProcessing() ? 'Processing...' : 'Import' }}
              </button>
              @if (ocrProcessing()) {
                <span class="text-sm text-muted-foreground">Please wait while OCR runs.</span>
              }
            </div>

            @if (ocrMessage()) {
              <div
                class="rounded-md border p-3 text-sm"
                [class.border-green-500]="ocrMessageTone() === 'success'"
                [class.text-green-600]="ocrMessageTone() === 'success'"
                [class.border-yellow-500]="ocrMessageTone() === 'warning'"
                [class.text-yellow-600]="ocrMessageTone() === 'warning'"
                [class.border-red-500]="ocrMessageTone() === 'error'"
                [class.text-red-600]="ocrMessageTone() === 'error'"
                [class.border-slate-300]="ocrMessageTone() === 'info'"
                [class.text-slate-600]="ocrMessageTone() === 'info'"
              >
                {{ ocrMessage() }}
              </div>
            }

            @if (passportPreviewUrl()) {
              <img class="passport-preview" [src]="passportPreviewUrl()" alt="Passport preview" />
            }

            <div class="space-y-2">
              <label class="text-sm font-medium">Paste image from clipboard</label>
              <div
                class="passport-clipboard"
                contenteditable="true"
                (paste)="onPastePassport($event)"
              >
                Click here and press Cmd+V / Ctrl+V to paste an image
              </div>
              @if (passportPastePreviewUrl()) {
                <img
                  class="passport-preview"
                  [src]="passportPastePreviewUrl()"
                  alt="Clipboard preview"
                />
              }
              @if (passportPasteStatus()) {
                <p class="text-sm text-muted-foreground">{{ passportPasteStatus() }}</p>
              }
            </div>
          </div>
        }

        <div class="grid gap-4 md:grid-cols-2">
          <div class="space-y-2">
            <label class="text-sm font-medium">Passport Number</label>
            <input z-input formControlName="passport_number" placeholder="Passport number" />
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Nationality</label>
            <z-combobox
              formControlName="nationality"
              [options]="nationalityOptions()"
              [searchable]="true"
              placeholder="Nationality"
              searchPlaceholder="Search country..."
              [zWidth]="'full'"
            />
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Passport Issue Date</label>
            <z-date-input formControlName="passport_issue_date"></z-date-input>
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Passport Expiration Date</label>
            <z-date-input formControlName="passport_expiration_date"></z-date-input>
            @if (
              form.get('passport_expiration_date')?.hasError('passportExpirationBeforeIssue') &&
              (form.get('passport_expiration_date')?.touched || submitted())
            ) {
              <p class="text-sm text-red-500">Expiration date cannot be earlier than issue date</p>
            }
          </div>
          @if (isPerson()) {
            <div class="space-y-2">
              <label class="text-sm font-medium">Birthdate</label>
              <z-date-input formControlName="birthdate"></z-date-input>
              @if (
                form.get('birthdate')?.hasError('birthdateAfterIssue') &&
                (form.get('birthdate')?.touched || submitted())
              ) {
                <p class="text-sm text-red-500">
                  Birthdate cannot be later than passport issue date
                </p>
              }
              @if (
                form.get('birthdate')?.hasError('birthdateAfterExpiration') &&
                (form.get('birthdate')?.touched || submitted())
              ) {
                <p class="text-sm text-red-500">
                  Birthdate cannot be later than passport expiration date
                </p>
              }
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium">Birth Place</label>
              <input z-input formControlName="birth_place" placeholder="Birth place" />
            </div>
          }
          <div class="space-y-2 md:col-span-2">
            <label class="text-sm font-medium">NPWP (Tax ID)</label>
            <input z-input formControlName="npwp" placeholder="Indonesian Tax ID" />
          </div>
        </div>
      </div>
    </z-card>

    <!-- 4) Contact Information -->
    <z-card class="overflow-hidden">
      <div class="bg-accent/30 px-6 py-4 border-b">
        <h2 class="text-sm font-semibold uppercase tracking-wider flex items-center gap-2">
          <z-icon zType="mail" class="h-4 w-4 text-primary" />
          4. Contact Information
        </h2>
      </div>
      <div class="p-6">
        <div class="grid gap-4 md:grid-cols-2">
          <div class="space-y-2">
            <label class="text-sm font-medium">Email</label>
            <input z-input type="email" formControlName="email" placeholder="Email address" />
            @if (form.get('email')?.errors?.['email'] && form.get('email')?.touched) {
              <p class="text-sm text-red-500">Invalid email address</p>
            }
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Telephone</label>
            <input z-input formControlName="telephone" placeholder="Phone number" />
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">WhatsApp</label>
            <input z-input formControlName="whatsapp" placeholder="WhatsApp number" />
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Telegram</label>
            <input z-input formControlName="telegram" placeholder="Telegram username/number" />
          </div>
        </div>
      </div>
    </z-card>

    <!-- 5) Social Media -->
    <z-card class="overflow-hidden">
      <div class="bg-accent/30 px-6 py-4 border-b">
        <h2 class="text-sm font-semibold uppercase tracking-wider flex items-center gap-2">
          <z-icon zType="share-2" class="h-4 w-4 text-primary" />
          5. Social Media
        </h2>
      </div>
      <div class="p-6">
        <div class="grid gap-4 md:grid-cols-3">
          <div class="space-y-2">
            <label class="text-sm font-medium">Facebook</label>
            <input z-input formControlName="facebook" placeholder="Facebook profile" />
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Instagram</label>
            <input z-input formControlName="instagram" placeholder="Instagram handle" />
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Twitter</label>
            <input z-input formControlName="twitter" placeholder="Twitter handle" />
          </div>
        </div>
      </div>
    </z-card>

    <!-- 6) Addresses -->
    <z-card class="overflow-hidden">
      <div class="bg-accent/30 px-6 py-4 border-b">
        <h2 class="text-sm font-semibold uppercase tracking-wider flex items-center gap-2">
          <z-icon zType="map-pin" class="h-4 w-4 text-primary" />
          6. Addresses
        </h2>
      </div>
      <div class="p-6">
        <div class="grid gap-4 md:grid-cols-2">
          <div class="space-y-2">
            <label class="text-sm font-medium">Address Bali</label>
            <textarea
              z-input
              formControlName="address_bali"
              placeholder="Address in Bali"
              rows="3"
            ></textarea>
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Address Abroad</label>
            <textarea
              z-input
              formControlName="address_abroad"
              placeholder="Address abroad"
              rows="3"
            ></textarea>
          </div>
        </div>
      </div>
    </z-card>

    <!-- 7) Notification Preferences -->
    <z-card class="overflow-hidden">
      <div class="bg-accent/30 px-6 py-4 border-b">
        <h2 class="text-sm font-semibold uppercase tracking-wider flex items-center gap-2">
          <z-icon zType="bell" class="h-4 w-4 text-primary" />
          7. Notification Preferences
        </h2>
      </div>
      <div class="p-6">
        <div class="grid gap-6 md:grid-cols-2">
          <div class="flex items-center gap-2 pt-8">
            <z-checkbox formControlName="notify_documents_expiration">
              Notify documents expiration
            </z-checkbox>
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Notify By</label>
            <select z-input formControlName="notify_by" class="w-full">
              @for (option of notifyByOptions; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
            @if (
              form.get('notify_documents_expiration')?.value &&
              !form.get('notify_by')?.value &&
              (form.get('notify_by')?.touched || submitted())
            ) {
              <p class="text-sm text-red-500">Notification method is required if enabled</p>
            }
          </div>
        </div>
      </div>
    </z-card>

    <!-- Form Actions -->
    <div class="flex justify-end gap-3 pb-8">
      <button type="button" z-button zType="outline" (click)="onCancel()" [zDisabled]="isLoading()">
        Cancel
      </button>
      <button type="submit" z-button zType="default" [zDisabled]="isLoading() || form.invalid">
        <z-icon *ngIf="isLoading()" zType="loader-circle" class="h-4 w-4 mr-2 animate-spin" />
        {{ isEditMode() ? 'Save Changes' : 'Create Customer' }}
      </button>
    </div>
  </form>
</div>
