@if (isLoading()) {
  <div class="space-y-6">
    <!-- Header Skeleton -->
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div class="space-y-2">
        <z-skeleton class="h-8 w-64" />
        <z-skeleton class="h-4 w-48" />
      </div>
      <div class="flex gap-2">
        <z-skeleton class="h-10 w-24" />
        <z-skeleton class="h-10 w-24" />
        <z-skeleton class="h-10 w-24" />
      </div>
    </div>

    <!-- Info Cards Skeletons -->
    <app-card-skeleton [lines]="5" />
    <app-card-skeleton [lines]="8" />
    <app-card-skeleton [lines]="4" />

    <!-- Applications List Skeleton -->
    <z-card class="p-6">
      <div class="mb-4">
        <z-skeleton class="h-6 w-1/4" />
      </div>
      <app-table-skeleton [rows]="5" [columns]="6" />
    </z-card>
  </div>
} @else if (!customer()) {
  <div class="text-muted-foreground">Customer not found.</div>
} @else {
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold">Customer ID #{{ customer()!.id }}</h1>
        <p class="text-sm text-muted-foreground">Customer detail</p>
      </div>
      <div class="flex flex-wrap gap-2">
        <a z-button zType="outline" routerLink="/customers/{{ customer()!.id }}/edit">Edit</a>
        @if (isSuperuser()) {
          <button z-button zType="destructive" (click)="onDelete()">Delete</button>
        }
        <a
          z-button
          zType="ghost"
          [routerLink]="'/customers'"
          [state]="{ focusTable: true, focusId: customer()!.id, searchQuery: originSearchQuery() }"
          >Back to list</a
        >
      </div>
    </div>

    <!-- Identity Section -->
    <z-card class="p-6">
      <div class="mb-4">
        <h3 class="text-lg font-semibold mb-3 border-b pb-2">Identity</h3>
        <div class="text-xl mb-2">
          @if (customer()!.title) {
            {{ customer()!.title }}.
          }
          @if (customer()!.firstName || customer()!.lastName) {
            {{ customer()!.firstName }} {{ customer()!.lastName }}
          } @else {
            {{ customer()!.fullName }}
          }
        </div>
        @if (customer()!.customerType === 'company' && customer()!.companyName) {
          <div class="text-sm text-muted-foreground mb-3">
            Company: {{ customer()!.companyName }}
          </div>
        }
        <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <dt class="text-sm font-medium text-muted-foreground">Customer Type</dt>
            <dd class="text-sm">{{ customer()!.customerType | titlecase }}</dd>
          </div>
          @if (customer()!.nationality) {
            <div>
              <dt class="text-sm font-medium text-muted-foreground">Nationality</dt>
              <dd class="text-sm">{{ customer()!.nationality }}</dd>
            </div>
          }
          @if (customer()!.birthPlace) {
            <div>
              <dt class="text-sm font-medium text-muted-foreground">Birth Place</dt>
              <dd class="text-sm">{{ customer()!.birthPlace }}</dd>
            </div>
          }
          @if (customer()!.birthdate) {
            <div>
              <dt class="text-sm font-medium text-muted-foreground">Birthdate</dt>
              <dd class="text-sm">{{ customer()!.birthdate | appDate }}</dd>
            </div>
          }
        </dl>
      </div>
    </z-card>

    <!-- Contact & Payment Section -->
    <z-card class="p-6">
      <div class="mb-4">
        <h3 class="text-lg font-semibold mb-3 border-b pb-2">Contact & Payment</h3>
        <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <dt class="text-sm font-medium text-muted-foreground">Email</dt>
            <dd class="text-sm">{{ customer()!.email || '—' }}</dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-muted-foreground">Telephone</dt>
            <dd class="text-sm">{{ customer()!.telephone || '—' }}</dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-muted-foreground">Whatsapp</dt>
            <dd class="text-sm">{{ customer()!.whatsapp || '—' }}</dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-muted-foreground">Telegram</dt>
            <dd class="text-sm">{{ customer()!.telegram || '—' }}</dd>
          </div>
          @if (customer()!.npwp) {
            <div>
              <dt class="text-sm font-medium text-muted-foreground">NPWP</dt>
              <dd class="text-sm">{{ customer()!.npwp }}</dd>
            </div>
          }
        </dl>
      </div>

      <!-- Address Section -->
      <div class="mb-4">
        <h4 class="text-md font-semibold mb-3 border-b pb-2">Address</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <strong class="text-sm font-medium">Address in Bali</strong>
            <div class="text-sm text-muted-foreground">{{ customer()!.addressBali || '—' }}</div>
          </div>
          <div>
            <strong class="text-sm font-medium">Address Abroad</strong>
            <div class="text-sm text-muted-foreground">{{ customer()!.addressAbroad || '—' }}</div>
          </div>
        </div>
      </div>

      <!-- Notifications Section -->
      <div>
        <h4 class="text-md font-semibold mb-3 border-b pb-2">Notifications</h4>
        <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <dt class="text-sm font-medium text-muted-foreground">Notify Expiration</dt>
            <dd class="text-sm">{{ customer()!.notifyDocumentsExpiration ? 'Yes' : 'No' }}</dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-muted-foreground">Notify By</dt>
            <dd class="text-sm">{{ customer()!.notifyBy || '—' }}</dd>
          </div>
        </dl>
      </div>
    </z-card>

    <!-- Passport Details Section -->
    <z-card class="p-6">
      <div class="mb-4 border-b pb-2">
        <h3 class="text-lg font-semibold">Passport Details</h3>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Passport Image -->
        <div>
          @if (customer()!.passportFile) {
            <a [href]="customer()!.passportFile" target="_blank" rel="noopener noreferrer">
              <div class="passport-magnifier-wrapper">
                <img
                  [src]="customer()!.passportFile"
                  alt="Passport Image"
                  class="passport-image w-full max-w-sm h-auto rounded-lg shadow-sm border"
                  (mouseenter)="onPassportMouseEnter()"
                  (mouseleave)="onPassportMouseLeave()"
                  (mousemove)="onPassportMouseMove($event)"
                />
                <div
                  class="passport-magnifier-lens"
                  [class.active]="magnifierEnabled() && magnifierActive()"
                  [style.width.px]="magnifierLensSize"
                  [style.height.px]="magnifierLensSize"
                  [style.left.px]="magnifierLensX()"
                  [style.top.px]="magnifierLensY()"
                  [style.background-image]="'url(' + customer()!.passportFile + ')'"
                  [style.background-size.%]="magnifierZoom * 100"
                  [style.background-position]="magnifierBgX() + '% ' + magnifierBgY() + '%'"
                ></div>
              </div>
            </a>
            <div class="mt-2 flex items-center justify-between gap-2 text-xs text-muted-foreground">
              <div>
                File:
                <a
                  [href]="customer()!.passportFile"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-primary hover:underline"
                  >{{ customer()!.passportFile | slice: -40 }}</a
                >
              </div>
              <button
                type="button"
                z-button
                zType="ghost"
                zSize="sm"
                class="h-8 w-8 shrink-0 p-0"
                [attr.aria-label]="
                  magnifierEnabled()
                    ? 'Disable passport magnifier lens on hover'
                    : 'Enable passport magnifier lens on hover'
                "
                [attr.title]="
                  magnifierEnabled()
                    ? 'Disable passport magnifier lens on hover'
                    : 'Enable passport magnifier lens on hover'
                "
                (click)="toggleMagnifier()"
              >
                <z-icon [zType]="magnifierEnabled() ? 'zoom-out' : 'zoom-in'" class="h-4 w-4" />
              </button>
            </div>
          } @else {
            <div class="text-muted-foreground text-sm">No passport file uploaded.</div>
          }
        </div>

        <!-- Passport Information -->
        <div>
          <table class="w-full">
            <tbody>
              @if (customer()!.passportNumber) {
                <tr>
                  <th scope="row" class="text-left py-2 text-sm font-medium">Passport Number</th>
                  <td class="text-left py-2 text-sm">{{ customer()!.passportNumber }}</td>
                </tr>
              }
              @if (customer()!.passportIssueDate) {
                <tr>
                  <th scope="row" class="text-left py-2 text-sm font-medium">
                    Passport Issue Date
                  </th>
                  <td class="text-left py-2 text-sm">
                    {{ customer()!.passportIssueDate | appDate }}
                  </td>
                </tr>
              }
              @if (customer()!.passportExpirationDate) {
                <tr>
                  <th scope="row" class="text-left py-2 text-sm font-medium">
                    Passport Expiration Date
                  </th>
                  <td class="text-left py-2 text-sm">
                    {{ customer()!.passportExpirationDate | appDate }}
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </z-card>

    <!-- Uninvoiced Applications Section -->
    <z-card class="p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold border-b pb-2">Uninvoiced Applications</h3>
        <button type="button" z-button zType="outline" zSize="sm" (click)="onCreateApplication()">
          New application
        </button>
      </div>

      @if (uninvoicedApplications().length > 0) {
        <div class="overflow-x-auto">
          <table class="w-full border-collapse">
            <thead>
              <tr class="border-b">
                <th class="text-left py-3 px-4 text-sm font-medium text-muted-foreground">#ID</th>
                <th class="text-left py-3 px-4 text-sm font-medium text-muted-foreground">
                  Product
                </th>
                <th class="text-left py-3 px-4 text-sm font-medium text-muted-foreground">Type</th>
                <th class="text-left py-3 px-4 text-sm font-medium text-muted-foreground">
                  Doc Date
                </th>
                <th class="text-left py-3 px-4 text-sm font-medium text-muted-foreground">
                  Status
                </th>
                <th class="text-left py-3 px-4 text-sm font-medium text-muted-foreground">
                  Invoice Actions
                </th>
              </tr>
            </thead>
            <tbody>
              @for (app of uninvoicedApplications(); track app.id) {
                <tr class="border-b hover:bg-muted/50">
                  <td class="py-3 px-4 text-sm">
                    <span class="text-primary font-medium">{{ app.id }}</span>
                  </td>
                  <td class="py-3 px-4 text-sm">
                    <span class="text-primary">{{ app.product.name }}</span>
                  </td>
                  <td class="py-3 px-4 text-sm">
                    {{ app.product.productTypeDisplay || (app.product.productType | titlecase) }}
                  </td>
                  <td class="py-3 px-4 text-sm">{{ app.docDate | appDate }}</td>
                  <td class="py-3 px-4 text-sm">
                    <z-badge [zType]="getStatusBadgeType(app.status)">{{
                      app.statusDisplay || (app.status | titlecase)
                    }}</z-badge>
                  </td>
                  <td class="py-3 px-4 text-sm">
                    <div class="flex flex-wrap items-center gap-2">
                      <a z-button zType="outline" zSize="sm" [routerLink]="['/applications', app.id]">
                        View App
                      </a>
                      @if (app.hasInvoice && app.invoiceId) {
                        <a z-button zType="outline" zSize="sm" [routerLink]="['/invoices', app.invoiceId]">
                          View Invoice
                        </a>
                      } @else if (canCreateInvoice(app)) {
                        <button
                          type="button"
                          z-button
                          zType="success"
                          zSize="sm"
                          (click)="onCreateInvoice(app.id)"
                        >
                          Create Invoice
                        </button>
                      } @else {
                        <z-badge zType="warning">Not Ready</z-badge>
                      }
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      } @else {
        <div class="text-muted-foreground text-sm">No uninvoiced applications found.</div>
      }
    </z-card>
  </div>
}
