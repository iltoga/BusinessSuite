<div class="h-full flex flex-col gap-6" [contextHelp]="'/customers'">
  <div class="flex justify-between items-center">
    <h1 class="text-3xl font-bold tracking-tight">Customer List</h1>
    <a
      routerLink="/customers/new"
      [state]="{ from: 'customers', searchQuery: query() }"
      [contextHelp]="'/customers/new'"
    >
      <z-button zType="default" zSize="default"> New Customer </z-button>
    </a>
  </div>

  <div class="bg-card rounded-lg border shadow-sm">
    <div class="p-4 border-b">
      <app-search-toolbar
        [query]="query()"
        [placeholder]="'Search Customers...'"
        (queryChange)="onQueryChange($event)"
        (tabOut)="onEnterSearch()"
      >
        <div class="flex items-center gap-3">
          <z-select class="w-40" [zValue]="statusFilter()" (zValueChange)="onStatusChange($event)">
            <z-select-item zValue="all">Show All</z-select-item>
            <z-select-item zValue="active">Enabled Only</z-select-item>
            <z-select-item zValue="disabled">Disabled Only</z-select-item>
          </z-select>

          @if (isSuperuser() && totalItems() > 0) {
            <z-button
              zType="destructive"
              zSize="sm"
              (click)="openBulkDeleteDialog()"
              [contextHelp]="{
                id: '/customers/bulk-delete',
                briefExplanation: 'Bulk delete customers',
                details:
                  'Deletes selected or all customers and their related data. Use filters or search to limit the affected set.',
              }"
            >
              {{ bulkDeleteLabel() }}
            </z-button>
          }
        </div>
      </app-search-toolbar>
    </div>

    <div class="p-0">
      <app-data-table
        #grid
        [columns]="columns()"
        [data]="customers()"
        [isLoading]="isLoading()"
        [actions]="actions()"
        [currentPage]="page()"
        [totalPages]="totalPages()"
        (pageChange)="onPageChange($event)"
        (sortChange)="onSortChange($event)"
      />
    </div>

    <div class="p-4 border-t bg-muted/20">
      <app-pagination-controls
        [page]="page()"
        [totalPages]="totalPages()"
        [totalItems]="totalItems()"
        (pageChange)="onPageChange($event)"
      />
    </div>
  </div>
</div>

<ng-template #customerTemplate let-row>
  <div class="flex items-center gap-2">
    <a [routerLink]="['/customers', row.id]" class="font-medium hover:underline">
      {{ row.fullNameWithCompany }}
    </a>
    @if (!row.active) {
      <z-badge variant="destructive" class="h-4 px-1 text-[10px] uppercase">Disabled</z-badge>
    }
  </div>
</ng-template>

<ng-template #passportTemplate let-row>
  <div class="flex flex-col gap-1">
    <div class="flex items-center gap-2">
      <span class="font-mono text-base font-medium">{{ row.passportNumber || '—' }}</span>
    </div>
    @if (row.passportExpirationDate) {
      <app-expiry-badge [date]="row.passportExpirationDate" />
    } @else {
      <span class="text-xs text-muted-foreground">—</span>
    }
  </div>
</ng-template>

<ng-template #emailTemplate let-row>
  <span>{{ row.email || '—' }}</span>
</ng-template>

<ng-template #whatsappTemplate let-row>
  @if (row.whatsapp) {
    <a
      [href]="getWhatsAppHref(row.whatsapp)"
      target="_blank"
      rel="noopener noreferrer"
      (click)="$event.stopPropagation()"
      class="text-primary hover:underline"
    >
      {{ row.whatsapp }}
    </a>
  } @else {
    <span>—</span>
  }
</ng-template>

<ng-template #nationalityTemplate let-row>
  <div class="flex items-center gap-2">
    <span>{{ row.nationalityName }}</span>
    @if (row.nationalityCode) {
      <span class="text-xs text-muted-foreground">({{ row.nationalityCode }})</span>
    }
  </div>
</ng-template>

<ng-template #createdAtTemplate let-row>
  <div class="flex flex-col">
    <span class="text-sm">{{
      row.createdAt ? (row.createdAt | date: 'dd MMM yyyy HH:mm:ss') : ''
    }}</span>
    @if (row.updatedAt && row.updatedAt !== row.createdAt) {
      <span class="text-xs text-muted-foreground">{{
        row.updatedAt ? (row.updatedAt | date: 'dd MMM yyyy HH:mm:ss') : ''
      }}</span>
    }
  </div>
</ng-template>

<app-bulk-delete-dialog
  [isOpen]="bulkDeleteOpen()"
  [data]="bulkDeleteData()"
  (confirmed)="onBulkDeleteConfirmed()"
  (cancelled)="onBulkDeleteCancelled()"
/>
