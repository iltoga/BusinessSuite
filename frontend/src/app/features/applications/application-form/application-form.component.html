<div class="max-w-4xl mx-auto space-y-8">
  <h1 class="text-3xl font-bold mb-4">
    {{ isEditMode() ? 'Edit Application' : 'New Application' }}
  </h1>

  @if (isLoading()) {
    <div class="text-muted-foreground">Loading application...</div>
  } @else {
    <form [formGroup]="form" (ngSubmit)="submit()" class="space-y-8">
      <app-form-error-summary [form]="form" [labels]="formErrorLabels" />

      <!-- Step 1: Application Details -->
      <z-card>
        <div class="flex items-center gap-3 mb-6">
          <z-icon zType="file-text" class="h-6 w-6 text-primary"></z-icon>
          <h2 class="text-xl font-semibold">Application Details</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <app-customer-select
              formControlName="customer"
              [label]="'Customer'"
              [placeholder]="'Select a customer...'"
              [searchPlaceholder]="'Search customers...'"
              [zStatus]="
                form.get('customer')?.invalid && form.get('customer')?.touched ? 'error' : undefined
              "
            />
            <div
              *ngIf="form.get('customer')?.invalid && form.get('customer')?.touched"
              class="text-xs text-destructive mt-1"
            >
              Customer is required
            </div>
          </div>

          <div>
            <app-product-select
              formControlName="product"
              (selectedIdChange)="onProductSelected($event)"
              [label]="'Product'"
              [placeholder]="'Select a product...'"
              [searchPlaceholder]="'Search products...'"
              [zWidth]="'full'"
              [zStatus]="
                form.get('product')?.invalid && form.get('product')?.touched ? 'error' : undefined
              "
            ></app-product-select>
            <div
              *ngIf="form.get('product')?.invalid && form.get('product')?.touched"
              class="text-xs text-destructive mt-1"
            >
              Product is required
            </div>
          </div>

          <div>
            <label class="text-sm font-medium">Doc Date</label>
            <z-date-input formControlName="docDate"></z-date-input>
          </div>

          <div>
            <label class="text-sm font-medium flex items-center gap-1 min-h-6 w-full">
              <span class="shrink-0">Due Date</span>
              <span
                class="min-w-0 truncate text-muted-foreground"
                [title]="dueDateContextLabel()"
                >{{ dueDateContextLabel() }}</span
              >
            </label>
            <z-date-input formControlName="dueDate"></z-date-input>
            <div
              *ngIf="
                form.get('dueDate')?.errors?.['dueBeforeDocDate'] && form.get('dueDate')?.touched
              "
              class="text-xs text-destructive mt-1"
            >
              Due date cannot be before Doc Date
            </div>
          </div>

          <div class="md:col-span-2 flex flex-wrap items-center gap-6">
            <label class="flex items-center gap-2">
              <input
                type="checkbox"
                formControlName="addDeadlinesToCalendar"
                class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
              />
              <span class="text-sm font-medium">Add deadlines to calendar</span>
            </label>

            <label
              class="flex items-center gap-2"
              [zTooltip]="
                canNotifyCustomer()
                  ? null
                  : 'Customer cannot be notified because we don\'t have his email or whatsapp'
              "
            >
              <input
                type="checkbox"
                formControlName="notifyCustomer"
                class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
              />
              <span class="text-sm font-medium">Notify customer</span>
            </label>
          </div>

          <div class="md:col-span-2" *ngIf="form.value.notifyCustomer">
            <label class="text-sm font-medium block mb-1">Customer notification channel</label>
            <z-combobox
              formControlName="notifyCustomerChannel"
              [options]="customerNotificationOptions()"
              [searchable]="false"
              [zWidth]="'full'"
            />
          </div>

          <div class="md:col-span-2">
            <label class="text-sm font-medium">Notes</label>
            <textarea
              formControlName="notes"
              class="block w-full mt-1 p-2 border rounded"
              rows="4"
            ></textarea>
          </div>
        </div>
      </z-card>

      <!-- Step 2: Application Documents -->
      <z-card>
        <div class="flex items-center gap-3 mb-6">
          <z-icon zType="folder" class="h-6 w-6 text-primary"></z-icon>
          <h2 class="text-xl font-semibold">Application Documents</h2>
        </div>

        <!-- Documents area: show skeleton while loading, show form rows when ready. -->
        <div class="space-y-4">
          <!-- Expand panel when loading or when documents exist -->
          <div *ngIf="documentsPanelOpen() || documentsArray.length > 0">
            <!-- Skeleton loader while documents are being fetched -->
            <div *ngIf="documentsLoading()" class="space-y-3">
              @for (_ of [0, 1, 2]; track $index) {
                <div
                  class="p-4 border rounded-lg bg-card text-card-foreground shadow-sm animate-pulse"
                >
                  <div class="flex items-end gap-4">
                    <div class="grow">
                      <div class="h-3 bg-slate-700 rounded mb-2 w-1/3"></div>
                      <div class="h-8 bg-slate-800 rounded w-full"></div>
                    </div>

                    <div class="flex items-center space-x-2 pb-2">
                      <div class="h-4 w-4 bg-slate-700 rounded"></div>
                      <div class="h-4 bg-slate-700 rounded w-12"></div>
                    </div>

                    <div class="pb-1">
                      <div class="h-8 w-20 bg-slate-700 rounded"></div>
                    </div>
                  </div>
                </div>
              }
            </div>

            <!-- Actual document rows -->
            <div *ngIf="!documentsLoading()">
              <div formArrayName="documents" class="space-y-4">
                @for (docGroup of documentsArray.controls; track $index) {
                  <div
                    [formGroupName]="$index"
                    class="p-4 border rounded-lg bg-card text-card-foreground shadow-sm"
                  >
                    <div class="flex items-end gap-4">
                      <div class="grow">
                        <label class="text-sm font-medium block mb-1">Document Type</label>
                        <z-combobox
                          formControlName="docTypeId"
                          [options]="getFilteredDocumentTypes($index)"
                          [searchable]="true"
                          placeholder="Select document type..."
                          [zWidth]="'full'"
                        />
                      </div>

                      <div class="flex items-center space-x-2 pb-2">
                        <input
                          type="checkbox"
                          id="doc-req-{{ $index }}"
                          formControlName="required"
                          class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
                        />
                        <label [for]="'doc-req-' + $index" class="text-sm font-medium"
                          >Required</label
                        >
                      </div>

                      <div class="pb-1">
                        <button
                          z-button
                          zType="destructive"
                          zSize="sm"
                          type="button"
                          (click)="removeDocument($index)"
                        >
                          Remove
                        </button>
                      </div>
                    </div>
                  </div>
                }
              </div>

              <div
                *ngIf="documentsArray.controls.length === 0"
                class="text-center text-sm text-muted-foreground py-4"
              >
                No required documents for this product.
              </div>
            </div>
          </div>

          <!-- Button to manually add a document (still available) -->
          <div class="mt-4 flex justify-center">
            <button
              z-button
              zType="secondary"
              type="button"
              (click)="addDocument()"
              [zDisabled]="documentsLoading() || !form.get('product')?.value"
            >
              Add Required Document
            </button>
          </div>
        </div>
      </z-card>

      <div class="flex items-center gap-3">
        <button z-button zType="default" type="submit" [zDisabled]="form.invalid || isSubmitting()">
          {{
            isSubmitting()
              ? isEditMode()
                ? 'Saving...'
                : 'Creating...'
              : isEditMode()
                ? 'Save'
                : 'Create'
          }}
        </button>
        <z-button zType="ghost" (click)="goBack()">Cancel</z-button>
      </div>
    </form>
  }
</div>
