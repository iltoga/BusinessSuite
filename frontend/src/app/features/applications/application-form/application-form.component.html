<div class="max-w-2xl">
  <h1 class="text-3xl font-bold mb-4">
    {{ isEditMode() ? 'Edit Application' : 'New Application' }}
  </h1>

  @if (isLoading()) {
    <div class="text-muted-foreground">Loading application...</div>
  } @else {
    <form [formGroup]="form" (ngSubmit)="submit()" class="space-y-4">
      <div>
        <label class="text-sm font-medium block mb-1">Customer</label>
        <z-combobox
          formControlName="customer"
          [options]="customerOptions()"
          [searchable]="true"
          placeholder="Select a customer..."
          searchPlaceholder="Search customers..."
          [zWidth]="'full'"
        />
        <div
          *ngIf="form.get('customer')?.invalid && form.get('customer')?.touched"
          class="text-xs text-destructive mt-1"
        >
          Customer is required
        </div>
      </div>

      <div>
        <label class="text-sm font-medium block mb-1">Product</label>
        <z-combobox
          formControlName="product"
          [options]="productOptions()"
          [searchable]="true"
          placeholder="Select a product..."
          searchPlaceholder="Search products..."
          [zWidth]="'full'"
        />
        <div
          *ngIf="form.get('product')?.invalid && form.get('product')?.touched"
          class="text-xs text-destructive mt-1"
        >
          Product is required
        </div>
      </div>

      <div>
        <label class="text-sm font-medium">Doc Date</label>
        <z-date-input formControlName="docDate" placeholder="DD-MM-YYYY"></z-date-input>
      </div>

      <div>
        <label class="text-sm font-medium">Notes</label>
        <textarea
          formControlName="notes"
          class="block w-full mt-1 p-2 border rounded"
          rows="4"
        ></textarea>
      </div>

      <!-- Application Documents Section -->
      <div class="pt-6 border-t">
        <h2 class="text-xl font-semibold mb-4 text-center">Application Documents</h2>

        <div formArrayName="documents" class="space-y-4">
          @for (docGroup of documentsArray.controls; track $index) {
            <div
              [formGroupName]="$index"
              class="p-4 border rounded-lg bg-card text-card-foreground shadow-sm"
            >
              <div class="flex items-end gap-4">
                <div class="grow">
                  <label class="text-sm font-medium block mb-1">Document Type</label>
                  <z-combobox
                    formControlName="docTypeId"
                    [options]="getFilteredDocumentTypes($index)"
                    [searchable]="true"
                    placeholder="Select document type..."
                    [zWidth]="'full'"
                  />
                </div>

                <div class="flex items-center space-x-2 pb-2">
                  <input
                    type="checkbox"
                    id="doc-req-{{ $index }}"
                    formControlName="required"
                    class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
                  />
                  <label [for]="'doc-req-' + $index" class="text-sm font-medium">Required</label>
                </div>

                <div class="pb-1">
                  <button
                    z-button
                    zType="destructive"
                    zSize="sm"
                    type="button"
                    (click)="removeDocument($index)"
                  >
                    Remove
                  </button>
                </div>
              </div>
            </div>
          }
        </div>

        <div class="mt-4 flex justify-center">
          <button
            z-button
            zType="secondary"
            type="button"
            (click)="addDocument()"
            [zDisabled]="!form.get('product')?.value"
          >
            Add Required Document
          </button>
        </div>
      </div>

      <div class="flex items-center gap-3 pt-6">
        <button z-button zType="default" type="submit" [zDisabled]="form.invalid || isSubmitting()">
          {{
            isSubmitting()
              ? isEditMode()
                ? 'Saving...'
                : 'Creating...'
              : isEditMode()
                ? 'Save'
                : 'Create'
          }}
        </button>
        <z-button zType="ghost" (click)="goBack()">Cancel</z-button>
      </div>
    </form>
  }
</div>
