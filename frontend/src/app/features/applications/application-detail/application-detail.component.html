@if (isLoading()) {
  <div class="space-y-6">
    <!-- Header Skeleton -->
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div class="space-y-2">
        <z-skeleton class="h-8 w-64" />
        <z-skeleton class="h-4 w-48" />
      </div>
      <div class="application-header-actions flex w-full flex-wrap gap-2 sm:w-auto">
        <z-skeleton class="h-10 w-24" />
        <z-skeleton class="h-10 w-24" />
      </div>
    </div>

    <!-- Info Card Skeleton -->
    <app-card-skeleton [lines]="4" />

    <!-- Workflow Card Skeleton -->
    <app-card-skeleton [lines]="6" />

    <!-- Documents Card Skeleton -->
    <z-card class="p-4 sm:p-6">
      <div class="mb-4">
        <z-skeleton class="h-6 w-1/4" />
      </div>
      <app-table-skeleton [rows]="5" [columns]="6" />
    </z-card>
  </div>
} @else if (!application()) {
  <div class="text-muted-foreground">Application not found.</div>
} @else {
  <div class="space-y-6">
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold">
          Application #{{ application()!.id }} ‚Äî {{ application()!.product.name }}
        </h1>
        <p class="text-sm text-muted-foreground">
          Customer: {{ application()!.customer.fullName }}
        </p>
      </div>
      <div class="application-header-actions flex w-full flex-wrap gap-2 sm:w-auto">
        @if (canCreateInvoice()) {
          <button
            z-button
            zType="success"
            (click)="createInvoice()"
            [disabled]="workflowAction() !== null"
          >
            Create Invoice
          </button>
        }
        @if (isSuperuser()) {
          <button
            z-button
            zType="destructive"
            (click)="deleteApplication()"
            [disabled]="workflowAction() !== null"
          >
            Delete Application
          </button>
        }
        @if (canForceClose()) {
          <button
            z-button
            zType="destructive"
            (click)="confirmForceClose()"
            [disabled]="workflowAction() !== null"
          >
            Force Close
          </button>
        }
        <button z-button zType="ghost" (click)="goBack()">Back</button>
      </div>
    </div>

    <z-card class="p-4 sm:p-6">
      <div class="grid gap-6">
        <div class="flex flex-wrap items-end gap-6">
          <div class="w-full sm:w-48">
            <div class="text-sm text-muted-foreground mb-1">Application Date</div>
            <z-date-input
              [ngModel]="docDateAsDate()"
              (ngModelChange)="onInlineDateChange('docDate', $event)"
            />
          </div>
          @if (application()!.dueDate) {
            <div
              class="w-full sm:w-48"
              [zTooltip]="isDueDateLocked() ? dueDateLockedTooltip : null"
            >
              <div class="text-sm text-muted-foreground mb-1 flex items-center gap-1 min-h-5">
                <span class="min-w-0 truncate" [title]="dueDateContextLabel()">
                  {{ dueDateContextLabel() }}
                </span>
              </div>
              <z-date-input
                [ngModel]="dueDateAsDate()"
                [disabled]="isDueDateLocked() || isSavingMeta()"
                (ngModelChange)="onInlineDateChange('dueDate', $event)"
              />
            </div>
          }
          <div class="application-meta-status ml-auto flex flex-col items-end">
            <div class="text-sm text-muted-foreground mb-1 text-right">Application Status</div>
            <z-badge [zType]="getApplicationStatusVariant(application()!.status)">
              {{ application()!.status | titlecase }}
            </z-badge>
          </div>
        </div>

        <div class="flex flex-wrap items-end gap-6">
          <div>
            <label class="flex items-center gap-2 text-sm">
              <input
                type="checkbox"
                [checked]="application()!.addDeadlinesToCalendar"
                (change)="onCalendarToggle($any($event.target).checked)"
                class="h-4 w-4 rounded border text-primary"
              />
              Add deadlines to calendar
            </label>
          </div>

          <div>
            <label class="flex items-center gap-2 text-sm">
              <input
                type="checkbox"
                [checked]="application()!.notifyCustomer ?? false"
                [disabled]="!canNotifyCustomer()"
                (change)="onNotifyCustomerToggle($any($event.target).checked)"
                class="h-4 w-4 rounded border text-primary"
              />
              Notify customer of deadlines
            </label>
            @if (!canNotifyCustomer()) {
              <div class="text-xs text-muted-foreground mt-1">
                Customer cannot be notified because no email or WhatsApp number is available.
              </div>
            }
          </div>

          @if (application()!.notifyCustomer && canNotifyCustomer()) {
            <div class="w-full sm:w-64">
              <div class="text-sm text-muted-foreground mb-1">Customer notification channel</div>
              <z-combobox
                [value]="application()!.notifyCustomerChannel"
                [options]="customerNotificationOptions()"
                [searchable]="false"
                [zWidth]="'full'"
                [disabled]="isSavingMeta()"
                (zValueChange)="onNotifyCustomerChannelChange($event)"
              />
            </div>
          }
        </div>

        <div>
          <div class="text-sm text-muted-foreground mb-1">Notes</div>
          <textarea
            z-input
            rows="3"
            class="w-full"
            [ngModel]="editableNotes()"
            (ngModelChange)="editableNotes.set($event)"
            (blur)="onNotesBlur()"
          ></textarea>
        </div>
      </div>
    </z-card>

    <z-card class="p-4 sm:p-6">
      <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
        <h3 class="text-lg font-semibold">Tasks Timeline</h3>
        <div class="flex flex-wrap gap-2">
          @if (canReopen()) {
            <button
              z-button
              zType="destructive"
              (click)="reopenApplication()"
              [disabled]="workflowAction() !== null"
            >
              Re-open Application
            </button>
          }
        </div>
      </div>

      <div class="mb-4">
        <z-badge [zType]="documentCollectionStatus().type">
          {{ documentCollectionStatus().label }}
        </z-badge>
      </div>

      @if (sortedWorkflows().length === 0) {
        <div class="text-sm text-muted-foreground">Not started yet</div>
      } @else {
        <ol class="timeline-list">
          @for (item of timelineItems(); track item.workflow.id; let isLast = $last) {
            <li class="timeline-item">
              <div class="timeline-track">
                <span
                  class="timeline-dot"
                  [ngClass]="getWorkflowDotClass(item.workflow.status)"
                ></span>
                @if (!isLast) {
                  <span class="timeline-line"></span>
                }
              </div>

              <div class="timeline-content">
                @if (item.gapDaysFromPrevious !== null) {
                  <div class="timeline-gap-label">
                    {{ getTimelineGapLabel(item.gapDaysFromPrevious) }}
                  </div>
                }

                <div class="rounded-lg border p-4">
                  <div class="flex flex-wrap items-center justify-between gap-3">
                    <div>
                      <div class="text-sm text-muted-foreground">
                        Step {{ item.workflow.task.step }}
                      </div>
                      <div class="font-medium">{{ item.workflow.task.name }}</div>
                    </div>
                    <div class="flex items-center gap-2">
                      <z-badge
                        [zType]="
                          getWorkflowStatusVariant(item.workflow.status, item.workflow.isOverdue)
                        "
                      >
                        {{ item.workflow.status | titlecase }}
                      </z-badge>
                      @if (canRollbackWorkflow(item.workflow)) {
                        <button
                          z-button
                          zType="outline"
                          zSize="sm"
                          (click)="rollbackWorkflow(item.workflow)"
                          [disabled]="workflowAction() !== null"
                        >
                          Cancel Task
                        </button>
                      }
                      @if (item.workflow.hasNotes) {
                        <span class="text-warning">&#9888;</span>
                      }
                    </div>
                  </div>

                  <div
                    class="mt-2 grid items-center gap-3 text-sm text-muted-foreground md:grid-cols-3"
                  >
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-foreground shrink-0">Start:</span>
                      <span>{{ item.workflow.startDate | appDate }}</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-foreground shrink-0">Due:</span>
                      @if (isWorkflowDueDateEditable(item.workflow)) {
                        <div class="w-full max-w-50">
                          <z-date-input
                            [ngModel]="getWorkflowDueDateAsDate(item.workflow)"
                            [disabled]="workflowAction() !== null"
                            (ngModelChange)="updateWorkflowDueDate(item.workflow, $event)"
                          />
                        </div>
                      } @else {
                        <span>{{ item.workflow.dueDate | appDate }}</span>
                      }
                    </div>
                    @if (item.workflow.completionDate) {
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-foreground shrink-0">
                          {{ item.workflow.status === 'rejected' ? 'Rejected:' : 'Completed:' }}
                        </span>
                        <span>{{ item.workflow.completionDate | appDate }}</span>
                      </div>
                    }
                  </div>

                  @if (isWorkflowEditable(item.workflow)) {
                    <div class="mt-3 max-w-xs">
                      <z-combobox
                        [value]="item.workflow.status"
                        [options]="getWorkflowStatusOptions(item.workflow)"
                        [searchable]="false"
                        [zWidth]="'full'"
                        [disabled]="workflowAction() !== null"
                        (zValueChange)="updateWorkflowStatus(item.workflow.id, $event)"
                      />
                    </div>
                    @if (getWorkflowStatusGuardMessage(item.workflow)) {
                      <div class="mt-2 text-xs text-muted-foreground">
                        {{ getWorkflowStatusGuardMessage(item.workflow) }}
                      </div>
                    }
                  }
                </div>
              </div>
            </li>
          }
        </ol>
      }
    </z-card>

    <z-card class="p-4 sm:p-6">
      <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
        <h3 class="text-lg font-semibold">Uploaded Documents</h3>
        <div class="flex flex-wrap gap-2">
          @if (selectedDocumentIds().size > 0) {
            <button
              z-button
              zType="success"
              (click)="mergeAndDownloadSelected()"
              [disabled]="isMerging()"
            >
              @if (isMerging()) {
                <span class="mr-2 inline-block animate-spin">‚è≥</span>
                Merging...
              } @else {
                Merge & Download PDF ({{ selectedDocumentIds().size }})
              }
            </button>
          }
          <button
            z-button
            zType="outline"
            (click)="openAddDocumentDialog()"
            [disabled]="filteredDocTypeOptions().length === 0"
          >
            Add Document type to the List
          </button>
        </div>
      </div>

      <!-- AI Document Categorization area -->
      @if (!isCategorizationActive()) {
        <div class="mb-4">
          <app-multi-file-upload
            accept="image/*,.pdf,.doc,.docx"
            label="Upload Multiple Documents"
            helperText="Drag and drop files to upload them. They will be automatically verified using AI."
            [disabled]="isCategorizationActive()"
            (filesSelected)="onCategorizationFilesSelected($event)"
            (cleared)="onCategorizationFilesCleared()"
          />
          @if (categorizationFiles().length > 0) {
            <div class="mt-2 flex justify-end">
              <button z-button zType="default" (click)="startCategorization()">
                ü§ñ Validate {{ categorizationFiles().length }} File(s) with AI
              </button>
            </div>
          }
        </div>
      }

      @if (isCategorizationActive()) {
        <div class="mb-4">
          <app-categorization-progress
            [totalFiles]="categorizationTotalFiles()"
            [processedFiles]="categorizationProcessedFiles()"
            [results]="categorizationResults()"
            [isComplete]="categorizationComplete()"
            [isApplying]="isCategorizationApplying()"
            [statusMessage]="categorizationStatusMessage()"
            (applyAll)="onApplyCategorization($event)"
            (dismiss)="dismissCategorization()"
          />
        </div>
      }

      @if (localUploadedDocuments().length === 0) {
        <div class="text-sm text-muted-foreground">No uploaded documents yet.</div>
      } @else {
        <div class="overflow-x-auto app-detail-table-wrap">
          <table class="app-detail-table app-uploaded-docs-table w-full border-collapse">
            <thead>
              <tr class="border-b text-sm text-muted-foreground">
                <th class="w-10"></th>
                <th class="w-10 py-2 px-2">
                  <input
                    type="checkbox"
                    [checked]="areAllUploadedDocumentsSelected()"
                    [indeterminate]="isUploadedDocumentSelectionPartial()"
                    (change)="toggleAllUploadedDocumentsSelection()"
                    class="h-4 w-4 rounded border text-primary"
                  />
                </th>
                <th class="text-left py-2">Document</th>
                <th class="text-left py-2">Doc Number</th>
                <th class="text-left py-2">Expiration</th>
                <th class="text-left py-2">Last Updated</th>
                <th class="text-left py-2">Completed</th>
                <th class="text-left py-2">AI Check</th>
                <th class="text-left py-2">Actions</th>
              </tr>
            </thead>
            <tbody cdkDropList (cdkDropListDropped)="onDocumentDrop($event)">
              @for (doc of localUploadedDocuments(); track doc.id) {
                <tr class="border-b bg-card uploaded-doc-row" cdkDrag>
                  <td class="py-3 px-2 uploaded-doc-sort-cell" data-label="Sort">
                    <div
                      class="cursor-move text-muted-foreground"
                      cdkDragHandle
                      title="Drag to reorder"
                    >
                      <z-icon zType="ellipsis" zSize="sm" class="rotate-90" />
                    </div>
                  </td>
                  <td class="py-3 px-2 uploaded-doc-select-cell" data-label="Select">
                    <input
                      type="checkbox"
                      [checked]="selectedDocumentIds().has(doc.id)"
                      (change)="toggleDocumentSelection(doc.id)"
                      class="h-4 w-4 rounded border text-primary"
                    />
                  </td>
                  <td class="py-3" data-label="Document">{{ doc.docType.name }}</td>
                  <td class="py-3" data-label="Doc Number">{{ doc.docNumber || '‚Äî' }}</td>
                  <td class="py-3" data-label="Expiration">{{ doc.expirationDate | appDate }}</td>
                  <td class="py-3" data-label="Last Updated">
                    <div class="text-sm">{{ doc.updatedAt | appDate: 'datetime' }}</div>
                    @if (doc.updatedByUsername) {
                      <div class="text-xs text-muted-foreground">{{ doc.updatedByUsername }}</div>
                    }
                  </td>
                  <td class="py-3" data-label="Completed">
                    @if (doc.completed) {
                      <z-badge zType="success">Yes</z-badge>
                    } @else {
                      <z-badge zType="secondary">No</z-badge>
                    }
                  </td>
                  <td class="py-3" data-label="AI Check">
                    @if (doc.aiValidationStatus === 'valid') {
                      <z-badge
                        zType="success"
                        [zTooltip]="$any(doc.aiValidationResult?.['reasoning']) || ''"
                        >‚úÖ Valid</z-badge
                      >
                    } @else if (doc.aiValidationStatus === 'invalid') {
                      <z-badge
                        zType="destructive"
                        [zTooltip]="$any(doc.aiValidationResult?.['reasoning']) || ''"
                        >‚ö†Ô∏è Invalid</z-badge
                      >
                    } @else if (
                      doc.aiValidationStatus === 'pending' ||
                      doc.aiValidationStatus === 'validating'
                    ) {
                      <z-badge zType="outline"
                        ><svg
                          class="inline-block mr-1 h-3.5 w-3.5 animate-spin text-muted-foreground"
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                        >
                          <circle
                            class="opacity-25"
                            cx="12"
                            cy="12"
                            r="10"
                            stroke="currentColor"
                            stroke-width="4"
                          ></circle>
                          <path
                            class="opacity-75"
                            fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"
                          ></path></svg
                        >Checking‚Ä¶</z-badge
                      >
                    } @else if (doc.aiValidationStatus === 'error') {
                      <z-badge zType="destructive">Error</z-badge>
                    } @else {
                      <span class="text-muted-foreground">‚Äî</span>
                    }
                  </td>
                  <td class="py-3 uploaded-doc-actions-cell" data-label="Actions">
                    <div class="flex flex-wrap gap-2">
                      <button z-button zType="warning" zSize="default" (click)="openUpload(doc)">
                        Update
                      </button>
                      <app-document-preview
                        [documentId]="doc.id"
                        [fileLink]="doc.fileLink"
                        [centerInViewport]="true"
                        zType="default"
                        zSize="default"
                        label="View"
                        (viewFull)="viewDocument(doc)"
                      />
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </z-card>

    <z-card class="p-4 sm:p-6">
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-lg font-semibold">Required Documents</h3>
      </div>
      @if (requiredDocuments().length === 0) {
        <div class="text-sm text-muted-foreground">No required documents pending.</div>
      } @else {
        <div class="overflow-x-auto app-detail-table-wrap">
          <table class="app-detail-table app-required-docs-table w-full border-collapse">
            <thead>
              <tr class="border-b text-sm text-muted-foreground">
                <th class="text-left py-2">Document</th>
                <th class="text-left py-2">Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (doc of requiredDocuments(); track doc.id) {
                <tr class="border-b app-doc-row">
                  <td class="py-3" data-label="Document">{{ doc.docType.name }}</td>
                  <td class="py-3 app-doc-actions-cell" data-label="Actions">
                    <div class="flex flex-wrap gap-2">
                      <button z-button zType="default" zSize="sm" (click)="openUpload(doc)">
                        Upload
                      </button>
                      <button
                        z-button
                        zType="destructive"
                        zSize="sm"
                        (click)="removeApplicationDocument(doc)"
                      >
                        Remove
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </z-card>

    @if (optionalDocuments().length > 0) {
      <z-card class="p-4 sm:p-6">
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-lg font-semibold">Optional Documents</h3>
        </div>
        <div class="overflow-x-auto app-detail-table-wrap">
          <table class="app-detail-table app-optional-docs-table w-full border-collapse">
            <thead>
              <tr class="border-b text-sm text-muted-foreground">
                <th class="text-left py-2">Document</th>
                <th class="text-left py-2">Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (doc of optionalDocuments(); track doc.id) {
                <tr class="border-b app-doc-row">
                  <td class="py-3" data-label="Document">{{ doc.docType.name }}</td>
                  <td class="py-3 app-doc-actions-cell" data-label="Actions">
                    <div class="flex flex-wrap gap-2">
                      <button z-button zType="default" zSize="sm" (click)="openUpload(doc)">
                        Upload
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </z-card>
    }
  </div>
}

@if (isAddDocumentDialogOpen()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
    <div class="w-full max-w-lg rounded-lg bg-card p-6 shadow-lg">
      <div class="flex items-start justify-between">
        <div>
          <h3 class="text-lg font-semibold">Add Document</h3>
          <p class="text-sm text-muted-foreground">Select the document type you want to add.</p>
        </div>
        <button z-button zType="ghost" zSize="sm" (click)="closeAddDocumentDialog()">x</button>
      </div>

      <div class="mt-6 space-y-4">
        <z-combobox
          [options]="filteredDocTypeOptions()"
          [value]="selectedNewDocType()"
          [searchable]="true"
          placeholder="Select doc type"
          [zWidth]="'full'"
          (zValueChange)="selectedNewDocType.set($event)"
        />
      </div>

      <div class="mt-6 flex justify-end gap-2">
        <button z-button zType="outline" (click)="closeAddDocumentDialog()">Cancel</button>
        <button
          z-button
          zType="default"
          (click)="addApplicationDocument()"
          [disabled]="!selectedNewDocType()"
        >
          Add Document
        </button>
      </div>
    </div>
  </div>
}

@if (isUploadOpen() && selectedDocument()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
    <div class="app-upload-dialog rounded-lg bg-card p-6 shadow-lg">
      <div class="flex items-start justify-between">
        <div>
          <h3 class="text-lg font-semibold">Upload {{ selectedDocument()!.docType.name }}</h3>
          <p class="text-sm text-muted-foreground">Attach file and update document details.</p>
        </div>
        <button z-button zType="ghost" zSize="sm" (click)="closeUpload()">Close</button>
      </div>

      <form class="app-upload-dialog-form mt-6 space-y-4" [formGroup]="uploadForm">
        <app-file-upload
          [label]="'Drop file here'"
          [accept]="selectedDocument()!.docType.hasFile ? '*/*' : ''"
          [fileName]="selectedFile()?.name || selectedDocument()!.fileLink || null"
          [progress]="uploadProgress()"
          [disabled]="isSaving()"
          [previewUrl]="inlinePreviewUrl()"
          [previewType]="inlinePreviewType()"
          [previewLoading]="inlinePreviewLoading()"
          [previewHeight]="'6rem'"
          [previewWidth]="'10rem'"
          [showMagnifierToggle]="false"
          (fileSelected)="onFileSelected($event)"
          (cleared)="onFileCleared()"
        />

        @if (selectedDocument()!.extraActions && selectedDocument()!.extraActions!.length > 0) {
          <div class="flex flex-wrap gap-2">
            @for (action of selectedDocument()!.extraActions; track action.name) {
              <button
                z-button
                zType="success"
                zSize="sm"
                type="button"
                (click)="executeAction(action)"
                [disabled]="actionLoading() !== null"
              >
                @if (action.icon) {
                  <i [class]="action.icon + ' mr-1'"></i>
                }
                {{ action.label }}
                @if (actionLoading() === action.name) {
                  <span class="ml-2 inline-block animate-spin">‚è≥</span>
                }
              </button>
            }
          </div>
        }

        @if (selectedDocument()!.docType.hasDocNumber) {
          <div class="space-y-2">
            <label class="text-sm font-medium">Document Number</label>
            <input z-input formControlName="docNumber" />
          </div>
        }

        @if (selectedDocument()!.docType.hasExpirationDate) {
          <div class="space-y-2">
            <label class="text-sm font-medium">Expiration Date</label>
            <z-date-input formControlName="expirationDate"></z-date-input>
          </div>
        }

        @if (selectedDocument()!.docType.hasDetails) {
          <div class="space-y-2">
            <label class="text-sm font-medium">Details</label>
            <textarea z-input rows="3" formControlName="details"></textarea>
          </div>
        }

        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="text-sm text-muted-foreground">
            @if (aiValidationInProgress()) {
              <span class="inline-flex items-center gap-1">
                <svg
                  class="inline-block h-4 w-4 animate-spin text-muted-foreground"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"
                  ></path>
                </svg>
                AI validation in progress‚Ä¶
              </span>
            } @else if (ocrPolling()) {
              OCR: {{ ocrStatus() || 'Processing' }}
            } @else if (selectedDocument()!.docType.aiValidation) {
              OCR available for this document.
            }
          </div>
          <div class="flex items-center gap-2">
            @if (
              isAiValidationEnabledForSelectedDocument() && hasAiValidationRules() && selectedFile()
            ) {
              <label class="flex items-center gap-1.5 text-sm cursor-pointer select-none">
                <input
                  type="checkbox"
                  class="h-4 w-4 rounded border-border"
                  [checked]="validateWithAi()"
                  (change)="validateWithAi.set($any($event.target).checked)"
                  [disabled]="isSaving() || aiValidationInProgress()"
                />
                Validate with AI
              </label>
            }
            <app-document-preview
              [documentId]="selectedDocument()!.id"
              [fileLink]="selectedDocument()!.fileLink"
              [centerInViewport]="true"
              zType="outline"
              zSize="sm"
              label="Full Preview"
              previewSize="md"
              (viewFull)="viewDocument(selectedDocument()!)"
            />
            @if (selectedDocument()!.docType.aiValidation) {
              <button
                z-button
                zType="outline"
                zSize="sm"
                type="button"
                (click)="runOcr()"
                [disabled]="ocrPolling()"
              >
                Run OCR
              </button>
            }
            <button
              z-button
              zType="default"
              type="button"
              (click)="onSaveDocument()"
              [zLoading]="isSaving() || aiValidationInProgress()"
              [disabled]="isSaving() || aiValidationInProgress()"
            >
              @if (aiValidationInProgress()) {
                Validating‚Ä¶
              } @else {
                Save
              }
            </button>
          </div>
        </div>

        @if (ocrPreviewImage() || ocrHasExtractedData()) {
          <div class="rounded-md border bg-muted/5 p-3">
            <div class="text-sm font-medium mb-2">OCR Preview</div>
            <div class="grid gap-4 md:grid-cols-2 md:items-start">
              <div
                class="rounded-md border bg-background p-2 min-h-48 flex items-center justify-center"
              >
                @if (ocrPreviewImage()) {
                  <app-image-magnifier
                    [src]="ocrPreviewImage()"
                    alt="OCR Preview"
                    [imageClass]="'max-h-72 w-auto max-w-full rounded object-contain'"
                    [wrapperClass]="'w-full max-w-64'"
                  />
                } @else {
                  <div class="text-xs text-muted-foreground">Preview image not available.</div>
                }
              </div>
              <div class="space-y-2">
                <label class="text-xs font-medium text-muted-foreground">Extracted Data</label>
                <textarea
                  z-input
                  rows="14"
                  readonly
                  class="w-full min-h-56 font-mono text-xs leading-5"
                  [value]="ocrExtractedDataText()"
                ></textarea>
              </div>
            </div>
          </div>
        }
      </form>
    </div>
  </div>
}

@if (ocrReviewOpen() && ocrReviewData()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
    <div class="w-full max-w-lg rounded-lg bg-card p-6 shadow-lg">
      <div class="flex items-start justify-between">
        <div>
          <h3 class="text-lg font-semibold">OCR Review</h3>
          <p class="text-sm text-muted-foreground">
            Review extracted data before applying to the document.
          </p>
        </div>
        <button z-button zType="ghost" zSize="sm" (click)="dismissOcrReview()">Close</button>
      </div>

      <div class="mt-4 space-y-3 text-sm">
        @if (ocrReviewData()!.mrzData?.number) {
          <div class="flex justify-between">
            <span class="text-muted-foreground">Document Number</span>
            <span>{{ ocrReviewData()!.mrzData?.number }}</span>
          </div>
        }
        @if (ocrReviewData()!.mrzData?.expirationDateYyyyMmDd) {
          <div class="flex justify-between">
            <span class="text-muted-foreground">Expiration Date</span>
            <span>{{ ocrReviewData()!.mrzData?.expirationDateYyyyMmDd | appDate }}</span>
          </div>
        }
        @if (ocrReviewData()!.aiWarning) {
          <div class="rounded-md bg-warning/10 p-2 text-warning">
            {{ ocrReviewData()!.aiWarning }}
          </div>
        }
      </div>

      <div class="mt-6 flex justify-end gap-2">
        <button z-button zType="outline" (click)="dismissOcrReview()">Dismiss</button>
        <button z-button zType="default" (click)="applyOcrData()">Apply Data</button>
      </div>
    </div>
  </div>
}
