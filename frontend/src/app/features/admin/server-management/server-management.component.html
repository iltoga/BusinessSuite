<div class="space-y-6">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold tracking-tight">Server Management</h1>
  </div>

  <!-- Server Actions -->
  <z-card class="p-6">
    <h3 class="text-lg font-medium mb-4">Server Actions</h3>
    <div class="flex gap-4">
      <button z-button (click)="clearCache()" [zDisabled]="isLoading()" zType="outline">
        @if (isLoading()) {
          <span>Clearing...</span>
        } @else {
          <span>Clear Cache</span>
        }
      </button>
      <button z-button (click)="runMediaDiagnostic()" [zDisabled]="isLoading()" zType="outline">
        @if (isLoading()) {
          <span>Running...</span>
        } @else {
          <span>Media Diagnostic</span>
        }
      </button>
      <button
        z-button
        (click)="repairMediaPaths()"
        [zDisabled]="isLoading() || !diagnosticResults().length"
        zType="outline"
      >
        @if (isLoading()) {
          <span>Repairing...</span>
        } @else {
          <span>Repair Media Paths</span>
        }
      </button>
    </div>
  </z-card>

  <!-- OpenRouter + AI Models -->
  <z-card class="p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-medium">OpenRouter & AI Models</h3>
      <button z-button zType="outline" (click)="loadOpenRouterStatus()" [zDisabled]="openRouterLoading()">
        @if (openRouterLoading()) {
          <span>Refreshing...</span>
        } @else {
          <span>Refresh</span>
        }
      </button>
    </div>

    @if (openRouterStatus(); as status) {
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="text-sm font-medium text-muted-foreground">OpenRouter Config</label>
          <div class="mt-1">
            <z-badge [zType]="status.openrouter.configured ? 'default' : 'destructive'">
              {{ status.openrouter.configured ? 'Configured' : 'Missing API Key' }}
            </z-badge>
          </div>
        </div>
        <div>
          <label class="text-sm font-medium text-muted-foreground">Effective Credit Remaining</label>
          <p class="text-sm font-mono bg-muted p-2 rounded mt-1">
            @if (status.openrouter.effectiveCreditRemaining !== null) {
              ${{ status.openrouter.effectiveCreditRemaining }}
            } @else {
              n/a
            }
          </p>
        </div>
        <div>
          <label class="text-sm font-medium text-muted-foreground">Current Provider / Default Model</label>
          <p class="text-sm font-mono bg-muted p-2 rounded mt-1 wrap-break-word">
            {{ status.aiModels.providerName }} / {{ status.aiModels.defaultModel }}
          </p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div class="text-sm bg-muted p-3 rounded">
          <div class="font-medium mb-1">Key Endpoint (`/key`)</div>
          <div>Status: {{ status.openrouter.keyStatus.ok ? 'OK' : 'Error' }}</div>
          @if (status.openrouter.keyStatus.message) {
            <div class="text-destructive mt-1">{{ status.openrouter.keyStatus.message }}</div>
          }
          @if (status.openrouter.keyStatus.limitRemaining !== null) {
            <div class="mt-1">Limit Remaining: ${{ status.openrouter.keyStatus.limitRemaining }}</div>
          }
          @if (status.openrouter.keyStatus.usageMonthly !== null) {
            <div class="mt-1">Usage Monthly: {{ status.openrouter.keyStatus.usageMonthly }}</div>
          }
        </div>
        <div class="text-sm bg-muted p-3 rounded">
          <div class="font-medium mb-1">Credits Endpoint (`/credits`)</div>
          <div>Status: {{ status.openrouter.creditsStatus.ok ? 'OK' : 'Unavailable' }}</div>
          @if (status.openrouter.creditsStatus.message) {
            <div class="text-muted-foreground mt-1">{{ status.openrouter.creditsStatus.message }}</div>
          }
          @if (status.openrouter.creditsStatus.remaining !== null) {
            <div class="mt-1">Remaining: ${{ status.openrouter.creditsStatus.remaining }}</div>
          }
          @if (status.openrouter.creditsStatus.totalCredits !== null) {
            <div class="mt-1">Total Credits: ${{ status.openrouter.creditsStatus.totalCredits }}</div>
          }
          @if (status.openrouter.creditsStatus.totalUsage !== null) {
            <div class="mt-1">Total Usage: ${{ status.openrouter.creditsStatus.totalUsage }}</div>
          }
        </div>
      </div>

      <div class="mb-4">
        <h4 class="text-sm font-medium mb-2">AI Features and Model Usage</h4>
        <div class="space-y-2">
          @for (feature of status.aiModels.features; track feature.feature) {
            <div class="text-sm bg-muted p-3 rounded">
              <div class="font-medium">{{ feature.feature }}</div>
              <div class="text-muted-foreground">{{ feature.purpose }}</div>
              <div class="mt-1 font-mono">Model: {{ feature.effectiveModel }}</div>
              <div class="text-muted-foreground">{{ feature.modelStrategy }}</div>
            </div>
          }
        </div>
      </div>

    } @else {
      <p class="text-sm text-muted-foreground">OpenRouter status not loaded yet.</p>
    }
  </z-card>

  <!-- Server Settings -->
  @if (serverSettings()) {
    <z-card class="p-6">
      <h3 class="text-lg font-medium mb-4">Server Settings</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="text-sm font-medium text-muted-foreground">Media Root</label>
          <p class="text-xs font-mono bg-muted p-2 rounded mt-1 wrap-break-word">
            {{ serverSettings()!.mediaRoot }}
          </p>
        </div>
        <div>
          <label class="text-sm font-medium text-muted-foreground">Media URL</label>
          <p class="text-xs font-mono bg-muted p-2 rounded mt-1 wrap-break-word">
            {{ serverSettings()!.mediaUrl }}
          </p>
        </div>
        <div>
          <label class="text-sm font-medium text-muted-foreground">Debug Mode</label>
          <div class="mt-1">
            <z-badge [zType]="serverSettings()!.debug ? 'destructive' : 'default'">
              {{ serverSettings()!.debug ? 'ON' : 'OFF' }}
            </z-badge>
          </div>
        </div>
      </div>
    </z-card>
  }

  <!-- Media Diagnostic Results -->
  @if (diagnosticResults().length > 0) {
    <z-card class="p-0">
      <div class="p-4 border-b">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-medium">Media Files Diagnostic</h3>
          <div class="flex gap-2">
            <z-badge zType="secondary"> Total: {{ diagnosticResults().length }} </z-badge>
            <z-badge zType="destructive"> Missing: {{ missingFilesCount() }} </z-badge>
            <z-badge zType="default"> With Discrepancy: {{ discrepancyCount() }} </z-badge>
          </div>
        </div>
      </div>
      <div class="max-h-96 overflow-auto">
        <table class="w-full">
          <thead class="bg-muted text-left">
            <tr>
              <th class="px-4 py-2 text-sm font-medium">Model</th>
              <th class="px-4 py-2 text-sm font-medium">ID</th>
              <th class="px-4 py-2 text-sm font-medium">Field</th>
              <th class="px-4 py-2 text-sm font-medium">Path</th>
              <th class="px-4 py-2 text-sm font-medium">Exists</th>
              <th class="px-4 py-2 text-sm font-medium">Issues</th>
            </tr>
          </thead>
          <tbody>
            @for (result of diagnosticResults(); track result.model + result.id + result.field) {
              <tr class="border-b">
                <td class="px-4 py-2 text-sm">{{ result.model }}</td>
                <td class="px-4 py-2 text-sm">{{ result.id }}</td>
                <td class="px-4 py-2 text-sm font-mono">{{ result.field }}</td>
                <td class="px-4 py-2 text-sm font-mono truncate max-w-xs" [title]="result.path">
                  {{ result.path }}
                </td>
                <td class="px-4 py-2">
                  <z-badge [zType]="result.exists ? 'default' : 'destructive'">
                    {{ result.exists ? 'Yes' : 'No' }}
                  </z-badge>
                </td>
                <td class="px-4 py-2">
                  <div class="flex gap-1">
                    @if (!result.exists) {
                      <z-badge zType="destructive" class="text-xs">Missing</z-badge>
                    }
                    @if (result.discrepancy) {
                      <z-badge zType="secondary" class="text-xs">URL Mismatch</z-badge>
                    }
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </z-card>
  }

  <!-- Repair Results -->
  @if (repairResults().length > 0) {
    <z-card class="p-6">
      <h3 class="text-lg font-medium mb-4">Media Repair Results</h3>
      <div class="space-y-2">
        @for (repair of repairResults(); track $index) {
          <div class="text-sm bg-muted p-2 rounded font-mono">{{ repair }}</div>
        }
      </div>
    </z-card>
  }
</div>
