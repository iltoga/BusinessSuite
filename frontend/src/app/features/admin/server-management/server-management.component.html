<div class="space-y-6">
  <div class="flex flex-wrap items-start justify-between gap-3">
    <h1 class="text-2xl font-bold tracking-tight">Server Management</h1>
  </div>

  <!-- Server Actions -->
  <z-card class="p-6">
    <h3 class="text-lg font-medium mb-4">Server Actions</h3>
    <div class="server-actions flex flex-wrap gap-3">
      <button
        z-button
        class="w-full sm:w-auto"
        (click)="clearCache()"
        [zDisabled]="isLoading()"
        zType="outline"
      >
        @if (isLoading()) {
          <span>Clearing...</span>
        } @else {
          <span>Clear Cache</span>
        }
      </button>
      <button
        z-button
        class="w-full sm:w-auto"
        (click)="runMediaDiagnostic()"
        [zDisabled]="isLoading()"
        zType="outline"
      >
        @if (isLoading()) {
          <span>Running...</span>
        } @else {
          <span>Media Diagnostic</span>
        }
      </button>
      <button
        z-button
        class="w-full sm:w-auto"
        (click)="repairMediaPaths()"
        [zDisabled]="isLoading() || !diagnosticResults().length"
        zType="outline"
      >
        @if (isLoading()) {
          <span>Repairing...</span>
        } @else {
          <span>Repair Media Paths</span>
        }
      </button>
    </div>
  </z-card>

  <!-- Cache Management -->
  <z-card class="p-6">
    <div class="mb-4 flex flex-wrap items-start justify-between gap-3">
      <h3 class="text-lg font-medium">Cache Management</h3>
      <div class="flex w-full flex-wrap gap-2 sm:w-auto">
        <button
          z-button
          zType="outline"
          class="w-full sm:w-auto"
          (click)="loadCacheStatus()"
          [zDisabled]="cacheLoading()"
        >
          @if (cacheLoading()) {
            <span>Refreshing...</span>
          } @else {
            <span>Refresh Status</span>
          }
        </button>
        <button
          z-button
          zType="outline"
          class="w-full sm:w-auto"
          (click)="runCacheHealthCheck()"
          [zDisabled]="cacheHealthLoading()"
        >
          @if (cacheHealthLoading()) {
            <span>Testing...</span>
          } @else {
            <span>Run Cache Test</span>
          }
        </button>
      </div>
    </div>

    @if (cacheStatus(); as status) {
      <div class="mb-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
        <div>
          <label class="text-sm font-medium text-muted-foreground">Cache Status</label>
          <div class="mt-1">
            <z-badge [zType]="status.enabled ? 'default' : 'secondary'">
              {{ status.enabled ? 'Enabled' : 'Disabled' }}
            </z-badge>
          </div>
        </div>
        <div>
          <label class="text-sm font-medium text-muted-foreground">Cache Version</label>
          <p class="text-sm font-mono bg-muted p-2 rounded mt-1">v{{ status.version }}</p>
        </div>
        <div>
          <label class="text-sm font-medium text-muted-foreground">Cache Backend Type</label>
          <p class="text-sm font-mono bg-muted p-2 rounded mt-1">
            {{ getCacheBackendType(status.cacheBackend || cacheHealth()?.cacheBackend) }}
          </p>
          @if (status.cacheBackend || cacheHealth()?.cacheBackend) {
            <p class="mt-1 text-xs text-muted-foreground wrap-break-word">
              {{ status.cacheBackend || cacheHealth()?.cacheBackend }}
            </p>
          }
        </div>
      </div>

      <div class="flex flex-wrap gap-3">
        <button
          z-button
          class="w-full sm:w-auto"
          (click)="toggleCache()"
          [zDisabled]="cacheLoading()"
          [zType]="status.enabled ? 'outline' : 'default'"
        >
          @if (cacheLoading()) {
            <span>Processing...</span>
          } @else {
            <span>{{ status.enabled ? 'Disable Cache' : 'Enable Cache' }}</span>
          }
        </button>
        <button
          z-button
          class="w-full sm:w-auto"
          (click)="clearUserCache()"
          [zDisabled]="cacheLoading() || !status.enabled"
          zType="destructive"
        >
          @if (cacheLoading()) {
            <span>Clearing...</span>
          } @else {
            <span>Clear My Cache</span>
          }
        </button>
      </div>
    } @else {
      <p class="text-sm text-muted-foreground">Cache status not loaded yet.</p>
    }

    <div class="mt-6 rounded border border-border/70 bg-muted/20 p-4">
      <h4 class="mb-3 text-sm font-semibold">Live Cache Probe</h4>
      @if (cacheHealth(); as probe) {
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
          <div>
            <label class="text-sm font-medium text-muted-foreground">Redis Connectivity</label>
            <div class="mt-1">
              @if (!probe.redisConfigured) {
                <z-badge zType="secondary">Not Redis Backend</z-badge>
              } @else {
                <z-badge [zType]="probe.redisConnected ? 'default' : 'destructive'">
                  {{ probe.redisConnected ? 'Online' : 'Offline' }}
                </z-badge>
              }
            </div>
          </div>
          <div>
            <label class="text-sm font-medium text-muted-foreground">Write/Read/Delete Probe</label>
            <div class="mt-1">
              <z-badge [zType]="probe.writeReadDeleteOk ? 'default' : 'destructive'">
                {{ probe.writeReadDeleteOk ? 'Pass' : 'Fail' }}
              </z-badge>
            </div>
          </div>
          <div>
            <label class="text-sm font-medium text-muted-foreground">Probe Latency</label>
            <p class="mt-1 rounded bg-muted p-2 font-mono text-sm">{{ probe.probeLatencyMs }} ms</p>
          </div>
        </div>
        <p class="mt-3 text-sm" [class.text-destructive]="!probe.ok">{{ probe.message }}</p>
        @if (probe.errors.length > 0) {
          <div class="mt-2 space-y-1">
            @for (error of probe.errors; track error) {
              <p class="text-xs text-destructive">{{ error }}</p>
            }
          </div>
        }
      } @else {
        <p class="text-sm text-muted-foreground">
          Run cache test to verify Redis connectivity and cache round-trip behavior.
        </p>
      }
    </div>
  </z-card>

  <!-- Local Resilience -->
  <z-card class="p-6">
    <div class="mb-4 flex flex-wrap items-start justify-between gap-3">
      <h3 class="text-lg font-medium">Local Resilience</h3>
      <div class="flex w-full flex-wrap gap-2 sm:w-auto">
        <button
          z-button
          zType="outline"
          class="w-full sm:w-auto"
          (click)="loadLocalResilience()"
          [zDisabled]="localResilienceLoading()"
        >
          @if (localResilienceLoading()) {
            <span>Refreshing...</span>
          } @else {
            <span>Refresh</span>
          }
        </button>
      </div>
    </div>

    @if (localResilience(); as local) {
      <div class="mb-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <div>
          <label class="text-sm font-medium text-muted-foreground">Status</label>
          <div class="mt-1">
            <z-badge [zType]="local.enabled ? 'default' : 'secondary'">
              {{ local.enabled ? 'Enabled' : 'Disabled' }}
            </z-badge>
          </div>
        </div>
        <div>
          <label class="text-sm font-medium text-muted-foreground">Desktop Mode</label>
          <p class="mt-1 rounded bg-muted p-2 font-mono text-sm">
            {{ getLocalDesktopModeLabel(local.desktopMode) }}
          </p>
        </div>
        <div>
          <label class="text-sm font-medium text-muted-foreground">Media Encryption</label>
          <div class="mt-1">
            <z-badge [zType]="local.encryptionRequired ? 'default' : 'destructive'">
              {{ local.encryptionRequired ? 'Required' : 'Optional' }}
            </z-badge>
          </div>
        </div>
        <div>
          <label class="text-sm font-medium text-muted-foreground">Vault Epoch</label>
          <p class="mt-1 rounded bg-muted p-2 font-mono text-sm">v{{ local.vaultEpoch }}</p>
        </div>
      </div>

      <div class="flex flex-wrap gap-3">
        <button
          z-button
          class="w-full sm:w-auto"
          (click)="toggleLocalResilience()"
          [zDisabled]="localResilienceSaving()"
          [zType]="local.enabled ? 'outline' : 'default'"
        >
          @if (localResilienceSaving()) {
            <span>Processing...</span>
          } @else {
            <span>{{ local.enabled ? 'Disable Local Resilience' : 'Enable Local Resilience' }}</span>
          }
        </button>
        <button
          z-button
          zType="destructive"
          class="w-full sm:w-auto"
          (click)="resetLocalVault()"
          [zDisabled]="localResilienceSaving()"
        >
          @if (localResilienceSaving()) {
            <span>Resetting...</span>
          } @else {
            <span>Reset Local Vault</span>
          }
        </button>
      </div>

      @if (isDesktop()) {
        <div class="mt-6 rounded border border-border/70 bg-muted/20 p-4 space-y-4">
          <div class="flex flex-wrap items-start justify-between gap-3">
            <h4 class="text-sm font-semibold">Desktop Local Runtime</h4>
            <button
              z-button
              zType="outline"
              class="w-full sm:w-auto"
              (click)="loadDesktopResilienceState()"
              [zDisabled]="desktopRuntimeLoading() || desktopVaultLoading()"
            >
              Refresh Desktop State
            </button>
          </div>

          <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-5">
            <div>
              <label class="text-sm font-medium text-muted-foreground">Runtime</label>
              <div class="mt-1">
                <z-badge
                  [zType]="desktopRuntimeStatus()?.running && desktopRuntimeStatus()?.healthy ? 'default' : 'secondary'"
                >
                  {{
                    desktopRuntimeStatus()?.running && desktopRuntimeStatus()?.healthy
                      ? 'Running'
                      : 'Not Running'
                  }}
                </z-badge>
              </div>
            </div>
            <div>
              <label class="text-sm font-medium text-muted-foreground">Vault</label>
              <div class="mt-1">
                <z-badge [zType]="desktopVaultStatus()?.unlocked ? 'default' : 'destructive'">
                  {{ desktopVaultStatus()?.unlocked ? 'Unlocked' : 'Locked' }}
                </z-badge>
              </div>
            </div>
            <div>
              <label class="text-sm font-medium text-muted-foreground">Last Sync Error</label>
              <p class="mt-1 rounded bg-muted p-2 font-mono text-xs">
                {{ desktopSyncStatus()?.lastError || 'None' }}
              </p>
            </div>
            <div>
              <label class="text-sm font-medium text-muted-foreground">Last Push</label>
              <p class="mt-1 rounded bg-muted p-2 font-mono text-xs">
                {{ desktopSyncStatus()?.lastPushAt || 'N/A' }}
              </p>
            </div>
            <div>
              <label class="text-sm font-medium text-muted-foreground">Last Pull</label>
              <p class="mt-1 rounded bg-muted p-2 font-mono text-xs">
                {{ desktopSyncStatus()?.lastPullAt || 'N/A' }}
              </p>
            </div>
          </div>

          <div class="flex flex-wrap gap-3">
            <input
              type="password"
              class="h-10 min-w-[240px] rounded-md border border-input bg-background px-3 text-sm"
              placeholder="Vault passphrase"
              [value]="desktopVaultPassphrase()"
              (input)="desktopVaultPassphrase.set($any($event.target).value || '')"
              (keydown.enter)="unlockDesktopVault()"
            />
            <button
              z-button
              class="w-full sm:w-auto"
              [zDisabled]="desktopRuntimeLoading() || desktopVaultLoading()"
              (click)="startDesktopLocalRuntime()"
            >
              Start Local Runtime
            </button>
            <button
              z-button
              zType="outline"
              class="w-full sm:w-auto"
              [zDisabled]="desktopRuntimeLoading() || desktopVaultLoading()"
              (click)="stopDesktopLocalRuntime()"
            >
              Stop Local Runtime
            </button>
            <button
              z-button
              zType="outline"
              class="w-full sm:w-auto"
              [zDisabled]="desktopRuntimeLoading() || desktopVaultLoading()"
              (click)="unlockDesktopVault()"
            >
              Unlock Vault
            </button>
            <button
              z-button
              zType="destructive"
              class="w-full sm:w-auto"
              [zDisabled]="desktopRuntimeLoading() || desktopVaultLoading()"
              (click)="lockDesktopVault()"
            >
              Lock Vault
            </button>
          </div>
        </div>
      }
    } @else {
      <p class="text-sm text-muted-foreground">
        Local resilience settings not loaded yet.
      </p>
    }
  </z-card>

  <!-- Server Settings -->
  @if (serverSettings()) {
    <z-card class="p-6">
      <h3 class="text-lg font-medium mb-4">Server Settings</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="text-sm font-medium text-muted-foreground">Media Root</label>
          <p class="text-xs font-mono bg-muted p-2 rounded mt-1 wrap-break-word">
            {{ serverSettings()!.mediaRoot }}
          </p>
        </div>
        <div>
          <label class="text-sm font-medium text-muted-foreground">Media URL</label>
          <p class="text-xs font-mono bg-muted p-2 rounded mt-1 wrap-break-word">
            {{ serverSettings()!.mediaUrl }}
          </p>
        </div>
        <div>
          <label class="text-sm font-medium text-muted-foreground">Debug Mode</label>
          <div class="mt-1">
            <z-badge [zType]="serverSettings()!.debug ? 'destructive' : 'default'">
              {{ serverSettings()!.debug ? 'ON' : 'OFF' }}
            </z-badge>
          </div>
        </div>
      </div>
    </z-card>
  }

  <!-- Media Diagnostic Results -->
  @if (diagnosticResults().length > 0) {
    <z-card class="p-0">
      <div class="p-4 border-b">
        <div class="flex flex-wrap items-start justify-between gap-3">
          <h3 class="text-lg font-medium">Media Files Diagnostic</h3>
          <div class="flex flex-wrap gap-2">
            <z-badge zType="secondary"> Total: {{ diagnosticResults().length }} </z-badge>
            <z-badge zType="destructive"> Missing: {{ missingFilesCount() }} </z-badge>
            <z-badge zType="default"> With Discrepancy: {{ discrepancyCount() }} </z-badge>
          </div>
        </div>
      </div>
      <div class="diagnostic-table-wrap max-h-96 overflow-auto">
        <table class="diagnostic-table w-full">
          <thead class="bg-muted text-left">
            <tr>
              <th class="px-4 py-2 text-sm font-medium">Model</th>
              <th class="px-4 py-2 text-sm font-medium">ID</th>
              <th class="px-4 py-2 text-sm font-medium">Field</th>
              <th class="px-4 py-2 text-sm font-medium">Path</th>
              <th class="px-4 py-2 text-sm font-medium">Exists</th>
              <th class="px-4 py-2 text-sm font-medium">Issues</th>
            </tr>
          </thead>
          <tbody>
            @for (result of diagnosticResults(); track result.model + result.id + result.field) {
              <tr class="border-b diagnostic-row">
                <td class="px-4 py-2 text-sm" data-label="Model">{{ result.model }}</td>
                <td class="px-4 py-2 text-sm" data-label="ID">{{ result.id }}</td>
                <td class="px-4 py-2 text-sm font-mono" data-label="Field">{{ result.field }}</td>
                <td
                  class="diagnostic-path-cell px-4 py-2 text-sm font-mono truncate max-w-xs"
                  data-label="Path"
                  [title]="result.path"
                >
                  {{ result.path }}
                </td>
                <td class="px-4 py-2" data-label="Exists">
                  <z-badge [zType]="result.exists ? 'default' : 'destructive'">
                    {{ result.exists ? 'Yes' : 'No' }}
                  </z-badge>
                </td>
                <td class="diagnostic-issues-cell px-4 py-2" data-label="Issues">
                  <div class="flex flex-wrap gap-1">
                    @if (!result.exists) {
                      <z-badge zType="destructive" class="text-xs">Missing</z-badge>
                    }
                    @if (result.discrepancy) {
                      <z-badge zType="secondary" class="text-xs">URL Mismatch</z-badge>
                    }
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </z-card>
  }

  <!-- Repair Results -->
  @if (repairResults().length > 0) {
    <z-card class="p-6">
      <h3 class="text-lg font-medium mb-4">Media Repair Results</h3>
      <div class="space-y-2">
        @for (repair of repairResults(); track $index) {
          <div class="text-sm bg-muted p-2 rounded font-mono">{{ repair }}</div>
        }
      </div>
    </z-card>
  }
</div>
