<div class="h-full flex flex-col gap-6" [contextHelp]="'/products'">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <h1 class="text-2xl font-bold tracking-tight sm:text-3xl">Products</h1>
    <a
      routerLink="/products/new"
      [state]="{ from: 'products', searchQuery: query() }"
      [contextHelp]="'/products/new'"
    >
      <z-button zType="default" zSize="default">New Product</z-button>
    </a>
  </div>

  <div class="bg-card rounded-lg border shadow-sm">
    <div class="border-b p-3 sm:p-4">
      <app-search-toolbar
        [query]="query()"
        [placeholder]="'Search Products...'"
        (queryChange)="onQueryChange($event)"
        (tabOut)="dataTable.focusFirstRowIfNone()"
        [contextHelp]="'/products/search'"
      >
        <z-button
          zType="default"
          zSize="sm"
          [zLoading]="exportInProgress()"
          [zDisabled]="exportInProgress() || importInProgress()"
          (click)="startExport()"
        >
          Export
          @if (exportInProgress() && exportProgress() !== null) {
            ({{ exportProgress() }}%)
          }
        </z-button>
        <z-button
          zType="default"
          zSize="sm"
          [zLoading]="importInProgress()"
          [zDisabled]="importInProgress() || exportInProgress()"
          (click)="openImportPicker()"
        >
          Import
          @if (importInProgress() && importProgress() !== null) {
            ({{ importProgress() }}%)
          }
        </z-button>
        @if (isSuperuser() && totalItems() > 0) {
          <z-button
            zType="destructive"
            zSize="sm"
            (click)="openBulkDeleteDialog()"
            [contextHelp]="'/products/bulk-delete'"
          >
            {{ bulkDeleteLabel() }}
          </z-button>
        }
      </app-search-toolbar>
      <input
        #importFileInput
        type="file"
        accept=".xlsx"
        class="hidden"
        (change)="onImportFileSelected($event)"
      />
    </div>

    <div class="p-0">
      <app-data-table
        #dataTable
        [columns]="columns()"
        [data]="products()"
        [actions]="actions()"
        [isLoading]="isLoading()"
        [currentPage]="page()"
        [totalPages]="totalPages()"
        (pageChange)="onPageChange($any($event))"
        (sortChange)="onSortChange($any($event))"
      />
    </div>

    <div class="border-t bg-muted/20 p-3 sm:p-4">
      <app-pagination-controls
        [page]="page()"
        [totalPages]="totalPages()"
        [totalItems]="totalItems()"
        (pageChange)="onPageChange($event)"
      />
    </div>
  </div>
</div>

<ng-template #nameTemplate let-row>
  <a
    [routerLink]="['/products', row.id]"
    [state]="{ from: 'products', focusId: row.id, searchQuery: query() }"
    class="font-medium hover:underline"
  >
    {{ row.name }}
  </a>
</ng-template>

<ng-template #descriptionTemplate let-row>
  <div
    class="text-sm text-muted-foreground"
    style="
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    "
    [zTooltip]="row.description || ''"
    zPosition="top"
  >
    {{ row.description }}
  </div>
</ng-template>

<ng-template #typeTemplate let-row>
  <z-badge zType="secondary">{{ productTypeLabel(row.productType) }}</z-badge>
</ng-template>

<ng-template #basePriceHeaderTemplate>
  <button
    type="button"
    tabindex="-1"
    class="inline-flex h-5 w-5 items-center justify-center rounded text-muted-foreground transition-colors hover:text-foreground"
    [attr.aria-label]="basePricesVisible() ? 'Hide base prices' : 'Show base prices'"
    [zTooltip]="basePricesVisible() ? 'Hide base prices' : 'Show base prices'"
    zPosition="top"
    (click)="toggleBasePriceVisibility($event)"
  >
    <z-icon [zType]="basePricesVisible() ? 'eye-off' : 'eye'" class="h-3.5 w-3.5" />
  </button>
</ng-template>

<ng-template #priceTemplate let-row>
  <span>{{ formatBasePrice(row.basePrice) }}</span>
</ng-template>

<ng-template #retailPriceTemplate let-row>
  <span>{{ formatCurrency(retailPriceValue(row)) }}</span>
</ng-template>

<ng-template #profitTemplate let-row>
  <span>{{ formatCurrency(unitProfitValue(row)) }}</span>
</ng-template>

<ng-template #createdAtTemplate let-row>
  <div class="flex flex-col">
    <span class="text-sm">{{
      $any(row).createdAt ? ($any(row).createdAt | appDate: 'datetime') : ''
    }}</span>
    @if ($any(row).updatedAt && $any(row).updatedAt !== $any(row).createdAt) {
      <span class="text-xs text-muted-foreground">{{
        $any(row).updatedAt ? ($any(row).updatedAt | appDate: 'datetime') : ''
      }}</span>
    }
  </div>
</ng-template>

<app-confirm-dialog
  [isOpen]="confirmOpen()"
  [title]="'Delete product'"
  [message]="confirmMessage()"
  [destructive]="true"
  confirmText="Delete"
  cancelText="Cancel"
  (confirmed)="confirmDelete()"
  (cancelled)="cancelDelete()"
/>

<app-bulk-delete-dialog
  [isOpen]="bulkDeleteOpen()"
  [data]="bulkDeleteData()"
  (confirmed)="onBulkDeleteConfirmed()"
  (cancelled)="onBulkDeleteCancelled()"
/>
