<div class="flex flex-col gap-6">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div class="flex flex-col gap-1">
      <p class="text-xs uppercase tracking-wider text-muted-foreground">Product Detail</p>
      @if (product()) {
        <h1 class="product-identity">{{ product()?.code }} · {{ product()?.name }}</h1>
      }
    </div>
    <div class="flex items-center gap-2">
      @if (product()) {
        <a [routerLink]="['/products', product()?.id, 'edit']">
          <z-button zType="warning" zSize="default">Edit</z-button>
        </a>
      }
      <a routerLink="/products">
        <z-button zType="outline" zSize="default">Back</z-button>
      </a>
    </div>
  </div>

  @if (isLoading()) {
    <div class="space-y-6">
      <app-card-skeleton [lines]="5" />
      <app-card-skeleton [lines]="4" />
      <z-card class="p-5">
        <div class="mb-4">
          <z-skeleton class="h-6 w-1/4" />
        </div>
        <app-table-skeleton [rows]="5" [columns]="7" />
      </z-card>
    </div>
  } @else if (product()) {
    <div class="grid gap-6 lg:grid-cols-3">
      <z-card class="p-5 lg:col-span-2">
        <div class="flex flex-col gap-4">
          <div class="flex flex-wrap items-center gap-3">
            <z-badge zType="secondary">{{ productTypeLabel(product()?.productType) }}</z-badge>
            <span class="base-price-chip">Base price: {{ product()?.basePrice ?? '—' }}</span>
            <span class="base-price-chip">Retail price: {{ retailPriceValue() ?? '—' }}</span>
            <span class="base-price-chip">Unit profit: {{ unitProfitValue() }}</span>
          </div>
          <div class="text-sm text-muted-foreground">
            {{ product()?.description || 'No description provided.' }}
          </div>
          <div class="space-y-1">
            <p class="text-xs uppercase text-muted-foreground">AI Validation Prompt</p>
            @if (validationPrompt()) {
              <p class="text-sm whitespace-pre-wrap rounded-md border bg-accent/20 px-3 py-2">
                {{ validationPrompt() }}
              </p>
            } @else {
              <p class="text-sm text-muted-foreground">No AI validation prompt configured.</p>
            }
          </div>
          <div class="grid gap-3 sm:grid-cols-3">
            <div>
              <p class="text-xs uppercase text-muted-foreground">Validity (days)</p>
              <p class="text-sm font-medium">{{ product()?.validity ?? '—' }}</p>
            </div>
            <div>
              <p class="text-xs uppercase text-muted-foreground">
                {{ documentsMinValidityLabel(product()?.productType) }}
              </p>
              <p class="text-sm font-medium">{{ product()?.documentsMinValidity ?? '—' }}</p>
            </div>
            <div>
              <p class="text-xs uppercase text-muted-foreground">
                {{ applicationWindowDaysLabel(product()?.productType) }}
              </p>
              <p class="text-sm font-medium">{{ product()?.applicationWindowDays ?? '—' }}</p>
            </div>
          </div>
          <div class="pt-4 border-t grid gap-3 sm:grid-cols-2">
            <div>
              <p class="text-xs uppercase text-muted-foreground">Created</p>
              <p class="text-sm">
                {{ product()?.createdAt | appDate: 'datetime' }}
                <span class="text-xs text-muted-foreground"
                  >(by {{ product()?.createdBy || '—' }})</span
                >
              </p>
            </div>
            <div>
              <p class="text-xs uppercase text-muted-foreground">Last Updated</p>
              <p class="text-sm">
                {{ product()?.updatedAt | appDate: 'datetime' }}
                @if (product()?.updatedBy) {
                  <span class="text-xs text-muted-foreground">(by {{ product()?.updatedBy }})</span>
                }
              </p>
            </div>
          </div>
        </div>
      </z-card>

      <z-card class="p-5">
        <div class="flex flex-col gap-4">
          <div>
            <p class="text-xs uppercase text-muted-foreground">Required documents</p>
            <div class="mt-2 flex flex-wrap gap-2">
              @if (requiredDocuments().length === 0) {
                <span class="text-sm text-muted-foreground">—</span>
              } @else {
                @for (doc of requiredDocuments(); track doc.id) {
                  <z-badge zType="outline">{{ doc.name }}</z-badge>
                }
              }
            </div>
          </div>
          <div>
            <p class="text-xs uppercase text-muted-foreground">Optional documents</p>
            <div class="mt-2 flex flex-wrap gap-2">
              @if (optionalDocuments().length === 0) {
                <span class="text-sm text-muted-foreground">—</span>
              } @else {
                @for (doc of optionalDocuments(); track doc.id) {
                  <z-badge zType="outline">{{ doc.name }}</z-badge>
                }
              }
            </div>
          </div>
        </div>
      </z-card>
    </div>

    <z-card class="p-5">
      <h2 class="text-lg font-semibold mb-4">Tasks</h2>
      <app-data-table [columns]="taskColumns()" [data]="tasks()" />
    </z-card>
  } @else {
    <div class="text-muted-foreground">Product not found.</div>
  }
</div>

<ng-template #lastStepTemplate let-row>
  <z-badge [zType]="row.lastStep ? 'success' : 'secondary'">
    {{ row.lastStep ? 'Yes' : 'No' }}
  </z-badge>
</ng-template>

<ng-template #notifyCustomerTemplate let-row>
  <z-badge [zType]="row.notifyCustomer ? 'success' : 'secondary'">
    {{ row.notifyCustomer ? 'Yes' : 'No' }}
  </z-badge>
</ng-template>

<ng-template #addToCalendarTemplate let-row>
  <z-badge [zType]="row.addTaskToCalendar ? 'success' : 'secondary'">
    {{ row.addTaskToCalendar ? 'Yes' : 'No' }}
  </z-badge>
</ng-template>

<ng-template #taskTemplate let-row>
  <div class="task-cell">
    <div class="task-name">{{ row.name || '—' }}</div>
    @if (row.description) {
      <div class="task-description">{{ row.description }}</div>
    }
  </div>
</ng-template>
