<div class="container mx-auto p-6 max-w-4xl">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Passport Uploadability Check</h1>
    <button
      appContextHelp
      class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        />
      </svg>
    </button>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
        >Verification Method</label
      >
      <div class="flex space-x-4">
        <label class="inline-flex items-center">
          <input
            type="radio"
            class="form-radio text-primary-600"
            name="method"
            value="hybrid"
            [ngModel]="method()"
            (ngModelChange)="method.set($event)"
          />
          <span class="ml-2 text-gray-700 dark:text-gray-300">Hybrid (Default)</span>
        </label>
        <label class="inline-flex items-center">
          <input
            type="radio"
            class="form-radio text-primary-600"
            name="method"
            value="ai"
            [ngModel]="method()"
            (ngModelChange)="method.set($event)"
          />
          <span class="ml-2 text-gray-700 dark:text-gray-300">AI (Accurate)</span>
        </label>
      </div>
    </div>

    <div class="mb-6 relative">
      <app-file-upload
        [label]="'Upload Passport Image'"
        [accept]="'image/*'"
        [disabled]="isChecking()"
        [fileName]="selectedFile()?.name ?? null"
        [previewUrl]="previewUrl()"
        [previewType]="'image'"
        [magnifierEnabledByDefault]="true"
        [helperText]="'Supported: JPG, PNG, GIF up to 10MB'"
        (fileSelected)="onFileSelected($event)"
        (cleared)="onFileCleared()"
      ></app-file-upload>

      <!-- Verified Stamp Overlay -->
      <div
        *ngIf="result()?.is_valid"
        class="absolute inset-0 flex items-center justify-center pointer-events-none z-10"
      >
        <div
          class="transform -rotate-12 border-4 border-green-500 text-green-500 text-4xl font-bold py-2 px-6 rounded-lg opacity-80 bg-white/20 backdrop-blur-sm"
        >
          VERIFIED
        </div>
      </div>

      <!-- Rejected Stamp Overlay -->
      <div
        *ngIf="result() && !result()?.is_valid"
        class="absolute inset-0 flex items-center justify-center pointer-events-none z-10"
      >
        <div
          class="transform -rotate-12 border-4 border-red-500 text-red-500 text-4xl font-bold py-2 px-6 rounded-lg opacity-80 bg-white/20 backdrop-blur-sm"
        >
          REJECTED
        </div>
      </div>
    </div>

    <div *ngIf="isChecking()" class="mb-6">
      <div class="flex justify-between mb-1">
        <span class="text-sm font-medium text-primary-700 dark:text-primary-400">{{
          progressMessage()
        }}</span>
        <span class="text-sm font-medium text-primary-700 dark:text-primary-400"
          >{{ progress() }}%</span
        >
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
        <div
          class="bg-primary-600 h-2.5 rounded-full transition-all duration-300"
          [style.width]="progress() + '%'"
        ></div>
      </div>

      <div
        *ngIf="processSteps().length > 0"
        class="mt-3 rounded-md border border-gray-200 dark:border-gray-700 p-3"
      >
        <p class="text-xs font-semibold text-gray-600 dark:text-gray-300 mb-2">Process steps</p>
        <ul class="space-y-1 text-xs text-gray-700 dark:text-gray-300">
          <li *ngFor="let step of processSteps(); let i = index" class="flex gap-2">
            <span class="font-semibold text-primary-600 dark:text-primary-400">{{ i + 1 }}.</span>
            <span>{{ step }}</span>
          </li>
        </ul>
      </div>
    </div>

    <div
      *ngIf="result()"
      class="mb-6 p-4 rounded-lg"
      [ngClass]="
        result()?.is_valid
          ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800'
          : 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800'
      "
    >
      <h3
        class="text-lg font-medium mb-2"
        [ngClass]="
          result()?.is_valid
            ? 'text-green-800 dark:text-green-300'
            : 'text-red-800 dark:text-red-300'
        "
      >
        {{ result()?.is_valid ? 'Passport Verified Successfully' : 'Passport Verification Failed' }}
      </h3>

      <p class="text-sm mb-2 text-gray-700 dark:text-gray-300">
        <strong>Method used:</strong> {{ result()?.method_used }}
      </p>

      <p *ngIf="result()?.model_used" class="text-sm mb-2 text-gray-700 dark:text-gray-300">
        <strong>Model used:</strong> {{ result()?.model_used }}
      </p>

      <div *ngIf="!result()?.is_valid" class="text-sm text-red-700 dark:text-red-400 mt-2">
        <strong>Reason:</strong> {{ getDisplayRejectionReason() }}
      </div>

      <div
        *ngIf="result()?.is_valid && result()?.passport_data"
        class="mt-4 grid grid-cols-2 gap-4 text-sm"
      >
        <div>
          <span class="block text-gray-500 dark:text-gray-400">Name</span>
          <span class="font-medium text-gray-900 dark:text-white"
            >{{ result()?.passport_data.first_name }} {{ result()?.passport_data.last_name }}</span
          >
        </div>
        <div>
          <span class="block text-gray-500 dark:text-gray-400">Passport Number</span>
          <span class="font-medium text-gray-900 dark:text-white">{{
            result()?.passport_data.passport_number
          }}</span>
        </div>
        <div>
          <span class="block text-gray-500 dark:text-gray-400">Nationality</span>
          <span class="font-medium text-gray-900 dark:text-white">{{
            result()?.passport_data.nationality
          }}</span>
        </div>
        <div>
          <span class="block text-gray-500 dark:text-gray-400">Expiration Date</span>
          <span class="font-medium text-gray-900 dark:text-white">{{
            result()?.passport_data.expiration_date
          }}</span>
        </div>
      </div>
    </div>

    <div class="flex justify-end">
      <button
        z-button
        zType="default"
        [zDisabled]="!selectedFile() || isChecking()"
        (click)="checkPassport()"
      >
        {{ isChecking() ? 'Checking...' : 'Check Passport' }}
      </button>
    </div>
  </div>
</div>

<!-- Update Customer Dialog -->
<app-confirm-dialog
  *ngIf="showUpdateDialog()"
  title="Update Existing Customer"
  message="I found a customer with the same name and nationality but an outdated passport. Do you want me to update their data directly?"
  confirmText="Update Customer"
  cancelText="Cancel"
  (confirm)="updateCustomer()"
  (cancel)="showUpdateDialog.set(false)"
>
</app-confirm-dialog>

<!-- Create Customer Dialog -->
<app-confirm-dialog
  *ngIf="showCreateDialog()"
  title="Create New Customer"
  message="This customer does not exist in the database. Do you want to create a new customer with this passport data?"
  confirmText="Create Customer"
  cancelText="Cancel"
  (confirm)="createNewCustomer()"
  (cancel)="showCreateDialog.set(false)"
>
</app-confirm-dialog>
