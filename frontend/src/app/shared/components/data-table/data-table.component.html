<div
  #tableWrapper
  class="data-table-focus-trap"
  tabindex="0"
  (focus)="focusFirstRowIfNone()"
  (keydown)="handleTableKeydown($event)"
  aria-label="Data table"
>
  <div class="data-table-scroll">
    <table z-table class="w-full">
      <thead z-table-header>
        <tr z-table-row>
          @for (column of columns(); track column.key) {
            <th z-table-head [class]="'col-' + (column.sortKey ?? column.key)">
              <div class="flex items-center gap-2" [class.justify-end]="column.key === 'actions'">
                <button
                  type="button"
                  class="flex items-center gap-2"
                  tabindex="-1"
                  [class.cursor-pointer]="column.sortable"
                  [ngClass]="{ 'text-foreground/70': !column.sortable }"
                  (click)="onSort(column)"
                >
                  <div
                    class="flex flex-col"
                    [class.items-end]="column.key === 'actions'"
                    [class.items-start]="column.key !== 'actions'"
                  >
                    <span [class.text-right]="column.key === 'actions'">{{ column.header }}</span>
                    @if (column.subtitle) {
                      <span class="text-xs font-normal text-foreground/70 normal-case">{{
                        column.subtitle
                      }}</span>
                    }
                  </div>
                  @if (currentSort()?.column === (column.sortKey ?? column.key)) {
                    <span class="text-xs text-muted-foreground">
                      {{ currentSort()?.direction === 'asc' ? '▲' : '▼' }}
                    </span>
                  }
                </button>

                @if (column.headerActionTemplate) {
                  <ng-container
                    *ngTemplateOutlet="column.headerActionTemplate; context: { column: column }"
                  />
                }

                @if (column.filter) {
                  <button
                    z-dropdown
                    [zDropdownMenu]="filterMenu"
                    type="button"
                    class="relative inline-flex h-7 w-7 items-center justify-center rounded border border-border/70 bg-muted/40 text-foreground transition-colors hover:bg-muted"
                    [class.filter-active]="hasActiveFilter(column)"
                    [attr.aria-label]="'Filter ' + column.header"
                    (click)="$event.stopPropagation()"
                  >
                    <z-icon zType="filter" class="h-3.5 w-3.5" />
                    @if ((column.filter.selectedValues?.length ?? 0) > 0) {
                      <span
                        class="absolute -right-1 -top-1 inline-flex min-w-4 items-center justify-center rounded-full bg-primary px-1 text-[10px] font-semibold text-primary-foreground"
                      >
                        {{ column.filter.selectedValues?.length ?? 0 }}
                      </span>
                    }
                  </button>

                  <z-dropdown-menu-content #filterMenu class="w-64 p-2">
                    <div class="mb-2 flex items-center justify-between gap-2">
                      <span
                        class="text-xs font-medium uppercase tracking-wide text-muted-foreground"
                      >
                        {{ column.header }}
                      </span>
                      <button
                        type="button"
                        class="text-xs font-medium text-primary hover:underline disabled:text-muted-foreground disabled:no-underline"
                        [disabled]="!hasActiveFilter(column)"
                        (click)="clearColumnFilter(column, $event)"
                      >
                        Clear
                      </button>
                    </div>

                    <input
                      type="text"
                      class="mb-2 h-8 w-full rounded border border-input bg-background px-2 text-xs outline-none focus:border-primary"
                      [value]="filterSearch()[column.key]"
                      [placeholder]="column.filter.searchPlaceholder || 'Search values...'"
                      (input)="onFilterSearchChange(column.key, $any($event.target).value)"
                      (click)="$event.stopPropagation()"
                    />

                    <div class="max-h-60 overflow-auto pr-1">
                      @if (getFilteredOptions(column).length === 0) {
                        <div class="px-1 py-2 text-xs text-muted-foreground">
                          {{ column.filter.emptyLabel || 'No values found' }}
                        </div>
                      } @else {
                        @for (option of getFilteredOptions(column); track option.value) {
                          <button
                            type="button"
                            class="flex cursor-pointer items-center gap-2 rounded px-1 py-1 text-xs hover:bg-muted/60"
                            (click)="toggleFilterValue(column, option.value, $event)"
                          >
                            <input
                              type="checkbox"
                              class="h-3.5 w-3.5 accent-primary"
                              [checked]="isFilterValueSelected(column, option.value)"
                              tabindex="-1"
                            />
                            <span class="truncate">{{ option.label }}</span>
                          </button>
                        }
                      }
                    </div>
                  </z-dropdown-menu-content>
                }
              </div>
            </th>
          }
        </tr>
      </thead>
      <tbody z-table-body>
        @if (isLoading()) {
          @for (i of [].constructor(skeletonRows()); track $index) {
            <tr z-table-row>
              @for (column of columns(); track column.key) {
                <td z-table-cell [attr.data-column-label]="column.header">
                  <z-skeleton class="h-8 w-full" />
                </td>
              }
            </tr>
          }
        } @else {
          @if (data().length === 0) {
            <tr z-table-row>
              <td
                z-table-cell
                [attr.colspan]="columns().length"
                class="text-center text-foreground/70"
              >
                No results
              </td>
            </tr>
          } @else {
            @for (row of data(); track (row && $any(row).id) || $index) {
              <tr
                #rowRef
                z-table-row
                [attr.tabindex]="selectedRow() === row ? 0 : -1"
                [attr.aria-selected]="selectedRow() === row ? 'true' : 'false'"
                [class.selected]="selectedRow() === row"
                [ngClass]="rowClass()?.(row) || ''"
                (focus)="selectRow(row, $event)"
                (click)="selectRow(row, $event)"
                (keydown)="handleRowKeydown($event, row); handleRowNavigationKeydown($event)"
              >
                @for (column of columns(); track column.key) {
                  <td
                    z-table-cell
                    [attr.data-column-label]="column.header"
                    [class]="'col-' + (column.sortKey ?? column.key)"
                  >
                    @if (column.template) {
                      <ng-container
                        *ngTemplateOutlet="
                          column.template;
                          context: { $implicit: row, value: getRawValue(row, column.key), row: row }
                        "
                      />
                    } @else if (column.key === 'actions' && actions()?.length) {
                      <div class="flex items-center justify-end">
                        <button
                          z-dropdown
                          [zDropdownMenu]="rowActionsMenu"
                          z-button
                          zType="ghost"
                          zSize="sm"
                          type="button"
                          class="h-8 w-8 p-0"
                          tabindex="-1"
                          (click)="$event.stopPropagation()"
                          aria-label="Row actions"
                          aria-haspopup="menu"
                        >
                          <z-icon zType="ellipsis-horizontal" />
                        </button>
                        <z-dropdown-menu-content #rowActionsMenu class="z-50 min-w-48">
                          @for (action of actions() ?? []; track action.label) {
                            @if (!action.isVisible || action.isVisible(row)) {
                              <button
                                z-dropdown-menu-item
                                type="button"
                                [variant]="
                                  action.variant ??
                                  (action.isDestructive ? 'destructive' : 'default')
                                "
                                (click)="onActionSelect(action, row, $event)"
                              >
                                <z-icon [zType]="action.icon" class="mr-2 h-4 w-4 stroke-current" />
                                <span
                                  [innerHTML]="action.label | shortcutHighlight: action.shortcut"
                                ></span>
                              </button>
                            }
                          }
                        </z-dropdown-menu-content>
                      </div>
                    } @else {
                      {{ getCellValue(row, column.key) }}
                    }
                  </td>
                }
              </tr>
            }
          }
        }
      </tbody>
    </table>
  </div>
</div>
