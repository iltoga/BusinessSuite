<div class="space-y-4">
  <h2 class="text-2xl font-bold">Calendar Overview</h2>

  <div class="grid gap-4">
    <app-dashboard-widget widgetTitle="Today" widgetSubtitle="Todo and done">
      @if (loading()) {
        <div class="grid gap-4 md:grid-cols-[minmax(0,1fr)_1px_minmax(0,1fr)] md:items-start">
          <div class="space-y-2 md:pr-4">
            <div
              class="flex items-center justify-between text-xs uppercase tracking-wide text-muted-foreground"
            >
              <z-skeleton class="h-3 w-12" />
              <z-skeleton class="h-3 w-6" />
            </div>
            <z-skeleton class="h-10 w-full rounded" />
          </div>

          <div class="hidden w-px bg-border/70 md:block"></div>

          <div class="space-y-2 md:pl-4">
            <div
              class="flex items-center justify-between text-xs uppercase tracking-wide text-muted-foreground"
            >
              <z-skeleton class="h-3 w-12" />
              <z-skeleton class="h-3 w-6" />
            </div>
            <z-skeleton class="h-10 w-full rounded" />
          </div>
        </div>
      } @else if (todayEvents().length === 0) {
        <div class="text-sm text-muted-foreground">No applications deadlines today.</div>
      } @else {
        <div class="grid gap-4 md:grid-cols-[minmax(0,1fr)_1px_minmax(0,1fr)] md:items-start">
          <section class="space-y-2 md:pr-4">
            <div
              class="flex items-center justify-between text-xs uppercase tracking-wide text-muted-foreground"
            >
              <span>Todo</span>
              <span>{{ todayTodoEvents().length }}</span>
            </div>
            @if (todayTodoEvents().length === 0) {
              <div
                class="rounded border border-dashed border-border/60 p-3 text-xs text-muted-foreground"
              >
                No todo events.
              </div>
            } @else {
              <ul class="space-y-2 text-sm">
                @for (event of todayTodoEvents(); track event.id) {
                  <li class="rounded border border-border/50 bg-background/40 px-2 py-2">
                    <div class="flex items-start gap-2">
                      <button
                        type="button"
                        class="mt-0.5 rounded-full text-muted-foreground transition hover:text-foreground disabled:cursor-not-allowed disabled:opacity-50"
                        [disabled]="isEventUpdating(event.id)"
                        [attr.aria-label]="'Mark ' + event.summary + ' done'"
                        (click)="toggleEventDone(event, $event)"
                      >
                        <z-icon zType="circle" class="h-4 w-4" />
                      </button>
                      <button
                        type="button"
                        class="min-w-0 flex-1 text-left"
                        (click)="openTodayEventDialog(event.id)"
                      >
                        <div class="font-medium">{{ event.summary }}</div>
                      </button>
                    </div>
                  </li>
                }
              </ul>
            }
          </section>

          <div class="hidden w-px bg-border/70 md:block"></div>

          <section class="space-y-2 md:pl-4">
            <div
              class="flex items-center justify-between text-xs uppercase tracking-wide text-muted-foreground"
            >
              <span>Done</span>
              <span>{{ todayDoneEvents().length }}</span>
            </div>
            @if (todayDoneEvents().length === 0) {
              <div
                class="rounded border border-dashed border-border/60 p-3 text-xs text-muted-foreground"
              >
                No completed events.
              </div>
            } @else {
              <ul class="space-y-2 text-sm">
                @for (event of todayDoneEvents(); track event.id) {
                  <li class="rounded border border-border/60 bg-muted/40 px-2 py-2">
                    <div class="flex items-start gap-2">
                      <button
                        type="button"
                        class="mt-0.5 cursor-default rounded-full text-primary"
                        disabled
                        [attr.aria-label]="'Completed: ' + event.summary"
                      >
                        <z-icon zType="circle-check" class="h-4 w-4" />
                      </button>
                      <button
                        type="button"
                        class="min-w-0 flex-1 text-left"
                        (click)="openTodayEventDialog(event.id)"
                      >
                        <div class="font-medium text-foreground">{{ event.summary }}</div>
                      </button>
                    </div>
                  </li>
                }
              </ul>
            }
          </section>
        </div>
      }
    </app-dashboard-widget>

    <div class="grid gap-4 lg:grid-cols-3">
      <app-dashboard-widget
        widgetTitle="Next Up: Your Upcoming Tasks"
        widgetSubtitle="Tomorrow to week end"
        class="lg:col-span-2"
      >
        @if (loading()) {
          <div #weekCalendarScrollRef class="week-calendar-scroll">
            <div class="week-calendar-grid">
              @for (col of [1, 2, 3, 4, 5, 6]; track col) {
                <div class="week-calendar-day">
                  <z-skeleton class="mb-3 h-4 w-24 rounded" />
                  <z-skeleton class="mb-2 h-10 w-full rounded" />
                  <z-skeleton class="h-10 w-full rounded" />
                </div>
              }
            </div>
          </div>
          <div
            class="week-calendar-drag-strip"
            [class.week-calendar-drag-strip--dragging]="weekCalendarDragging()"
            (pointerdown)="onWeekCalendarDragStart($event)"
            (pointermove)="onWeekCalendarDragMove($event)"
            (pointerup)="onWeekCalendarDragEnd($event)"
            (pointercancel)="onWeekCalendarDragEnd($event)"
          >
            <span class="week-calendar-drag-strip__hint">Click and drag here to scroll</span>
          </div>
        } @else if (restOfWeekCalendarDays().length === 0) {
          <div class="text-sm text-muted-foreground">Nothing yet for the rest of the week.</div>
        } @else {
          <div #weekCalendarScrollRef class="week-calendar-scroll">
            <div class="week-calendar-grid">
              @for (day of restOfWeekCalendarDays(); track day.key) {
                <section
                  class="week-calendar-day"
                  [class.week-calendar-day--weekend]="day.isWeekend"
                >
                  <header class="week-calendar-day__header">
                    <span class="week-calendar-day__label">{{ day.label }}</span>
                    <span class="week-calendar-day__date">{{ day.shortDate }}</span>
                  </header>

                  @if (day.events.length === 0) {
                    <div class="week-calendar-empty">No tasks</div>
                  } @else {
                    <ul class="week-calendar-events">
                      @for (event of day.events; track event.id) {
                        <li class="week-calendar-event">
                          @if (applicationIdFromSummary(event.summary); as applicationId) {
                            <button
                              type="button"
                              class="week-calendar-event__title week-calendar-event__title--button"
                              (click)="openWeeklyApplicationDetail(applicationId)"
                            >
                              <span class="week-calendar-event__title-text">{{
                                event.summary
                              }}</span>
                              <z-icon zType="arrow-up-right" class="h-3.5 w-3.5 shrink-0" />
                            </button>
                          } @else {
                            <div class="week-calendar-event__title">{{ event.summary }}</div>
                          }
                          <div class="week-calendar-event__meta">
                            {{ event.startDate | appDate }}
                          </div>
                        </li>
                      }
                    </ul>
                  }
                </section>
              }
            </div>
          </div>
          <div
            class="week-calendar-drag-strip"
            [class.week-calendar-drag-strip--dragging]="weekCalendarDragging()"
            (pointerdown)="onWeekCalendarDragStart($event)"
            (pointermove)="onWeekCalendarDragMove($event)"
            (pointerup)="onWeekCalendarDragEnd($event)"
            (pointercancel)="onWeekCalendarDragEnd($event)"
          >
            <span class="week-calendar-drag-strip__hint">Click and drag here to scroll</span>
          </div>
          @if (restOfWeekEvents().length === 0) {
            <div class="mt-3 text-xs text-muted-foreground">
              No tasks scheduled for the remaining days.
            </div>
          }
        }
      </app-dashboard-widget>

      <app-dashboard-widget widgetTitle="Month" widgetSubtitle="Hover or click days for details">
        <div #monthWidgetContainerRef class="relative">
          <div
            class="mb-2 flex items-center justify-center gap-2 text-xs font-medium text-muted-foreground"
          >
            <button
              type="button"
              z-button
              zType="ghost"
              zSize="sm"
              class="h-6 w-6 p-0"
              aria-label="Previous month"
              (click)="showPreviousMonth()"
            >
              <z-icon zType="chevron-left" class="h-4 w-4" />
            </button>
            <span class="min-w-28 text-center">{{ activeMonthLabel() }}</span>
            <button
              type="button"
              z-button
              zType="ghost"
              zSize="sm"
              class="h-6 w-6 p-0"
              aria-label="Next month"
              (click)="showNextMonth()"
            >
              <z-icon zType="chevron-right" class="h-4 w-4" />
            </button>
          </div>
          <div
            class="mb-2 text-center text-xs text-muted-foreground"
            style="display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 0.25rem"
          >
            @for (day of ['S', 'M', 'T', 'W', 'T', 'F', 'S']; track day + $index) {
              <div>{{ day }}</div>
            }
          </div>
          <div
            style="display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 0.25rem"
          >
            @for (day of monthGrid(); track day.key) {
              <button
                data-month-day="true"
                class="relative h-8 w-full rounded border text-xs transition"
                [class.bg-primary/15]="day.hasEvents"
                [class.border-primary/40]="day.hasEvents"
                [class.border-border/50]="!day.hasEvents"
                [class.text-foreground/40]="day.isWeekend && !day.isHoliday"
                [class.text-muted-foreground]="!day.inMonth && !(day.isWeekend && !day.isHoliday)"
                [class.text-destructive]="day.isHoliday"
                (mouseenter)="scheduleOpenDay(day, $event)"
                (mouseleave)="onMonthDayMouseLeave()"
                (click)="onMonthDayClick(day)"
              >
                <span class="block text-center">{{ day.date.getDate() }}</span>
              </button>
            }
          </div>

          @if (!openDayEventsDate() && hoverInfoLabel(); as infoLabel) {
            <div
              class="pointer-events-none absolute z-30 -translate-x-1/2 -translate-y-full whitespace-nowrap rounded-md border border-border bg-card px-2 py-1 text-xs text-foreground shadow-lg"
              [style.left.px]="hoverTooltipPosition()?.left"
              [style.top.px]="hoverTooltipPosition()?.top"
            >
              {{ infoLabel }}
            </div>
          }
        </div>
      </app-dashboard-widget>
    </div>

    <app-dashboard-widget widgetTitle="Overdue Applications" widgetSubtitle="Due date passed">
      @if (loading()) {
        <div class="space-y-2">
          <z-skeleton class="h-12 w-full rounded" />
          <z-skeleton class="h-12 w-full rounded" />
          <z-skeleton class="h-12 w-full rounded" />
        </div>
      } @else if (overdueApplications().length === 0) {
        <div class="text-sm text-muted-foreground">No overdue applications.</div>
      } @else {
        <ul class="space-y-2 text-sm">
          @for (event of overdueApplications(); track event.id) {
            <li class="rounded border border-border/50 px-3 py-2">
              <div class="flex items-start gap-2">
                <button
                  type="button"
                  class="mt-0.5 rounded-full text-muted-foreground transition hover:text-foreground disabled:cursor-not-allowed disabled:opacity-50"
                  [disabled]="isEventUpdating(event.id)"
                  [attr.aria-label]="'Mark overdue ' + event.summary + ' done'"
                  (click)="confirmOverdueApplicationDone(event, $event)"
                >
                  <z-icon zType="circle" class="h-4 w-4" />
                </button>
                <div class="min-w-0 flex-1">
                  <div class="font-medium">{{ event.summary }}</div>
                  <div class="text-xs text-muted-foreground">
                    Due {{ event.startDate | appDate }}
                  </div>
                </div>
              </div>
            </li>
          }
        </ul>
      }
    </app-dashboard-widget>

    @if (openDayEventsDate()) {
      <div class="pointer-events-none fixed inset-0 z-10000 flex items-center justify-center p-4">
        <div
          class="pointer-events-auto w-full max-w-2xl rounded-lg border-2 border-primary/50 bg-card p-4 shadow-xl"
        >
          <div class="mb-3 flex items-center justify-between">
            <h3 class="text-sm font-semibold">{{ openDayEventsDate() | appDate }}</h3>
            <div class="flex items-center gap-2">
              <div class="text-xs text-muted-foreground">
                {{ selectedDayEvents().length }} event(s)
              </div>
              <button
                type="button"
                z-button
                zType="ghost"
                zSize="sm"
                class="h-7 w-7 p-0"
                aria-label="Close day details"
                (click)="closeDayEventsDialog()"
              >
                <z-icon zType="x" class="h-4 w-4" />
              </button>
            </div>
          </div>

          <div class="mb-3 flex flex-wrap gap-2">
            @if (selectedDayWeekendLabel(); as weekendLabel) {
              <span
                class="inline-flex items-center rounded border border-muted bg-muted/60 px-2 py-1 text-xs text-foreground/80"
              >
                Weekend: {{ weekendLabel }}
              </span>
            }
            @if (selectedDayNationalHolidayNames().length > 0) {
              <span
                class="inline-flex items-center rounded border border-destructive/30 bg-destructive/10 px-2 py-1 text-xs text-destructive"
              >
                Holiday: {{ selectedDayNationalHolidayNames().join(', ') }}
              </span>
            }
          </div>

          <ul class="space-y-2 text-sm">
            @for (event of selectedDayEvents(); track event.id) {
              @if (applicationIdFromSummary(event.summary); as applicationId) {
                <li>
                  <button
                    type="button"
                    class="flex w-full items-center justify-between rounded border border-border/50 px-3 py-2 text-left transition hover:border-primary/40 hover:bg-muted/40"
                    (click)="openApplicationDetail(applicationId)"
                  >
                    <span>{{ event.summary }}</span>
                    <z-icon zType="arrow-up-right" class="h-4 w-4 text-muted-foreground" />
                  </button>
                </li>
              } @else {
                <li class="rounded border border-border/50 px-3 py-2">{{ event.summary }}</li>
              }
            }
          </ul>
        </div>
      </div>
    }
  </div>
</div>

<ng-template #todayEventDetailsTemplate>
  @if (selectedTodayEvent(); as selected) {
    <div class="space-y-3 text-sm">
      <div>
        <p class="text-xs text-muted-foreground">
          {{ selected.startDate | appDate: 'datetime' }}
        </p>
        @if (selected.endDate) {
          <p class="text-xs text-muted-foreground">
            Ends {{ selected.endDate | appDate: 'datetime' }}
          </p>
        }
      </div>

      @if (selected.description) {
        <div>
          <p class="text-xs uppercase tracking-wide text-muted-foreground">Details</p>
          <p class="whitespace-pre-wrap text-sm">{{ selected.description }}</p>
        </div>
      }

      @if (eventAlerts(selected).length > 0) {
        <div>
          <p class="text-xs uppercase tracking-wide text-muted-foreground">Alerts</p>
          <ul class="list-disc space-y-1 pl-5">
            @for (alert of eventAlerts(selected); track alert + $index) {
              <li>{{ alert }}</li>
            }
          </ul>
        </div>
      }

      @if (selected.htmlLink) {
        <a
          class="inline-block text-xs text-primary underline-offset-4 hover:underline"
          [href]="selected.htmlLink"
          target="_blank"
          rel="noopener noreferrer"
        >
          Open in Google Calendar
        </a>
      }
    </div>
  }
</ng-template>
