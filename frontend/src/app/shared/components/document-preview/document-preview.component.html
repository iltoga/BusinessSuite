@if (fileLink()) {
  <button
    z-button
    [zType]="zType()"
    [zSize]="zSize()"
    type="button"
    zPopover
    #popover="zPopover"
    [zContent]="previewContent"
    zTrigger="click"
    zPlacement="top"
    [zMatchTriggerWidth]="false"
    [zCenterInViewport]="centerInViewport()"
    (zVisibleChange)="onPopoverToggle($event)"
  >
    {{ label() }}
  </button>

  <ng-template #previewContent>
    <z-popover [class]="popoverClasses()">
      <!-- The enclosing <z-popover> receives styles; the directive on the button controls centering behavior -->
      <div class="space-y-2">
        <div class="flex items-center justify-between">
          <span class="text-xs font-medium text-muted-foreground truncate">
            {{ fileName() }}
          </span>
        </div>
        <div class="overflow-hidden rounded border bg-muted/20 flex items-center justify-center">
          <div [class]="previewFrameClasses() + ' flex items-center justify-center'">
            @if (isLoading()) {
              <div class="text-xs text-muted-foreground animate-pulse">Loading preview...</div>
            } @else if (previewUrl()) {
              @if (isPdf()) {
                @if (isPdfImage()) {
                  <app-image-magnifier
                    [src]="previewUrl()"
                    alt="PDF Preview"
                    [imageClass]="previewImageClasses()"
                    [wrapperClass]="'w-full max-w-full'"
                  />
                } @else {
                  <iframe [src]="sanitizedPreview()" class="w-full h-full border-0"></iframe>
                }
              } @else if (isImage()) {
                <app-image-magnifier
                  [src]="previewUrl()"
                  alt="Document Preview"
                  [imageClass]="previewImageClasses()"
                  [wrapperClass]="'w-full max-w-full'"
                />
              } @else {
                <div
                  class="w-full flex items-center justify-center text-xs text-muted-foreground p-4"
                >
                  Preview not available.
                </div>
              }
            } @else {
              <div class="text-xs text-muted-foreground text-center p-4">
                Preview not available.
              </div>
            }
          </div>
        </div>
        <div class="flex justify-end">
          <button z-button zType="ghost" zSize="sm" class="h-7 text-xs" (click)="onViewFull()">
            View Full
          </button>
        </div>
      </div>
    </z-popover>
  </ng-template>

  <ng-template #overlayContainer></ng-template>
}
