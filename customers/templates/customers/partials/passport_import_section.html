{% load crispy_forms_tags %}
{% load static %}
{% with prefix=prefix|default:"" %}
{% with container_id=container_id|default:"passport-import" %}
<div
    id="{{ container_id }}"
    class="passport-import-section"
    data-passport-import="true"
    data-prefix="{{ prefix }}"
    data-customer-type-selector='{{ customer_type_selector|default:"" }}'
    data-first-name-id="{{ first_name_id|default:'id_first_name' }}"
    data-last-name-id="{{ last_name_id|default:'id_last_name' }}"
    data-gender-id="{{ gender_id|default:'id_gender' }}"
    data-title-id="{{ title_id|default:'id_title' }}"
    data-nationality-id="{{ nationality_id|default:'id_nationality' }}"
    data-birthdate-id="{{ birthdate_id|default:'id_birthdate' }}"
    data-birth-place-id="{{ birth_place_id|default:'id_birth_place' }}"
    data-passport-number-id="{{ passport_number_id|default:'id_passport_number' }}"
    data-passport-issue-id="{{ passport_issue_id|default:'id_passport_issue_date' }}"
    data-passport-expiration-id="{{ passport_expiration_id|default:'id_passport_expiration_date' }}"
    data-address-abroad-id="{{ address_abroad_id|default:'id_address_abroad' }}"
    data-ocr-url="{% url 'api-ocr-check' %}"
>
    {% if passport_field %}
        {{ passport_field|as_crispy_field }}
    {% else %}
        <div class="mb-3">
            <label for="id_{{ prefix }}passport_file" class="form-label">Import data from Passport</label>
            <input type="file" class="form-control" id="id_{{ prefix }}passport_file" name="{{ prefix }}passport_file" accept="image/*,application/pdf">
        </div>
    {% endif %}
    <div class="mb-3">
        <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="{{ prefix }}use_ai_extraction" data-role="use-ai-toggle">
            <label class="form-check-label" for="{{ prefix }}use_ai_extraction">
                <i class="bi bi-robot me-1"></i>Use AI-enhanced extraction
                <small class="text-muted">(extracts additional fields like birth place)</small>
            </label>
        </div>
        <button type="button" class="btn btn-primary btn-sm" data-role="passport-import-button">
            <i class="bi bi-file-earmark-text me-1"></i>
            <span data-role="button-text">Import</span>
            <span class="spinner-border spinner-border-sm ms-1 d-none" role="status" data-role="passport-import-spinner" aria-label="Loading"></span>
        </button>
        <div class="alert alert-danger alert-dismissible fade show mt-2 d-none" role="alert" data-role="passport-import-error">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span data-role="error-message"></span>
            <button type="button" class="btn-close" onclick="this.parentElement.classList.add('d-none')"></button>
        </div>
        <div class="alert alert-success alert-dismissible fade show mt-2 d-none" role="alert" data-role="passport-import-success">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span data-role="success-message"></span>
            <button type="button" class="btn-close" onclick="this.parentElement.classList.add('d-none')"></button>
        </div>
        <div class="mt-2">
            <img data-role="passport-import-preview" class="img-thumbnail d-none" style="max-width:600px;" alt="Passport preview" />
        </div>
    </div>
    <div class="mb-3">
        <label for="clipboard_{{ prefix }}area" class="form-label">Paste image from clipboard:</label>
        <div id="clipboard_{{ prefix }}area" contenteditable="true" class="form-control" data-role="passport-clipboard-area" style="min-height:80px; border:2px dashed #ccc;">
            Click here and press Ctrl+V / Cmd+V to paste an image
        </div>
        <img data-role="passport-clipboard-preview" style="display:none; max-width:600px; margin-top:10px;" alt="Clipboard preview" />
        <div data-role="passport-clipboard-status" class="mt-2"></div>
    </div>
</div>
<script>
/* Load passport import script safely when the template is included multiple times */
(function(){
    var scriptUrl = '{% static "js/passport_import.js" %}';
    if (!document.querySelector('script[src="' + scriptUrl + '"]')) {
        var s = document.createElement('script');
        s.src = scriptUrl;
        s.defer = true;
        document.head.appendChild(s);
    }
})();
</script>
{% endwith %}
{% endwith %}
