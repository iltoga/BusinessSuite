<div class="pdf-viewer-wrapper shadow-sm border rounded bg-light mb-3">
    <div class="pdf-toolbar d-flex justify-content-between align-items-center p-2 border-bottom bg-white sticky-top" style="z-index: 10;">
        <div class="btn-group btn-group-sm">
            <button id="prev-{{ id }}" class="btn btn-outline-secondary" title="Previous Page"><i class="bi bi-chevron-left"></i></button>
            <button id="next-{{ id }}" class="btn btn-outline-secondary" title="Next Page"><i class="bi bi-chevron-right"></i></button>
        </div>
        <div class="text-muted small fw-bold">
            Page <span id="page-num-{{ id }}">0</span> / <span id="page-count-{{ id }}">0</span>
        </div>
        <div class="btn-group btn-group-sm">
            <button id="zoom-out-{{ id }}" class="btn btn-outline-secondary" title="Zoom Out"><i class="bi bi-zoom-out"></i></button>
            <button id="zoom-in-{{ id }}" class="btn btn-outline-secondary" title="Zoom In"><i class="bi bi-zoom-in"></i></button>
            <button id="expand-{{ id }}" class="btn btn-outline-secondary" title="Full Screen"><i class="bi bi-arrows-fullscreen"></i></button>
            <a href="{{ pdf_url }}" target="_blank" class="btn btn-outline-primary" title="Download PDF"><i class="bi bi-download"></i></a>
        </div>
    </div>
    <div id="pdf-container-{{ id }}" class="pdf-container text-center p-3" data-pdf-height="{{ height|default:'800px' }}" style="overflow: auto; background-color: #525659;">
        <canvas id="pdf-canvas-{{ id }}" class="mx-auto shadow-lg bg-white" style="display: none;"></canvas>
        <div id="pdf-loader-{{ id }}" class="p-5">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-light mt-2">Loading PDF preview...</p>
        </div>
    </div>
</div>

{% if not pdfjs_script_included %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    window.pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>
{% endif %}

<script>
(function() {
    const url = '{{ pdf_url }}';
    const id = '{{ id }}';
    let pdfDoc = null,
        pageNum = 1,
        pageRendering = false,
        pageNumPending = null,
        scale = 1.5,
        container = document.getElementById('pdf-container-' + id),
        canvas = document.getElementById('pdf-canvas-' + id),
        ctx = canvas.getContext('2d');

    // Set container height from data attribute to avoid CSS validation errors in template
    if (container.dataset.pdfHeight) {
        container.style.height = container.dataset.pdfHeight;
    }

    function renderPage(num) {
        pageRendering = true;
        pdfDoc.getPage(num).then(function(page) {
            const viewport = page.getViewport({scale: scale});
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            const renderTask = page.render(renderContext);

            renderTask.promise.then(function() {
                pageRendering = false;
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
                document.getElementById('pdf-loader-' + id).style.display = 'none';
                canvas.style.display = 'block';
            });
        });

        document.getElementById('page-num-' + id).textContent = num;
    }

    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    document.getElementById('prev-' + id).addEventListener('click', function() {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    });

    document.getElementById('next-' + id).addEventListener('click', function() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    });

    document.getElementById('zoom-in-' + id).addEventListener('click', function() {
        scale += 0.2;
        queueRenderPage(pageNum);
    });

    document.getElementById('zoom-out-' + id).addEventListener('click', function() {
        if (scale <= 0.5) return;
        scale -= 0.2;
        queueRenderPage(pageNum);
    });

    document.getElementById('expand-' + id).addEventListener('click', function() {
        const container = document.getElementById('pdf-container-' + id);
        if (container.requestFullscreen) {
            container.requestFullscreen();
        } else if (container.webkitRequestFullscreen) {
            container.webkitRequestFullscreen();
        } else if (container.msRequestFullscreen) {
            container.msRequestFullscreen();
        }
    });

    pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
        pdfDoc = pdfDoc_;
        document.getElementById('page-count-' + id).textContent = pdfDoc.numPages;
        renderPage(pageNum);
    }).catch(function(err) {
        console.error('Error loading PDF:', err);
        document.getElementById('pdf-loader-' + id).innerHTML =
            '<div class="alert alert-danger m-3">Error loading PDF preview. <br><small>' + err.message + '</small><br><a href="' + url + '" target="_blank" class="btn btn-sm btn-danger mt-2">Download PDF instead</a></div>';
    });
})();
</script>
