{% extends "reports/base_report.html" %}
{% load static %}
{% load humanize %}

{% block report_title %}Monthly Invoice Details{% endblock %}
{% block report_heading %}Monthly Invoice Details - {{ month_name }} {{ selected_year }}{% endblock %}
{% block report_description %}Detailed listing of all invoices for the selected month{% endblock %}

{% block report_content %}
<!-- Filter Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label for="month" class="form-label">Month</label>
                        <select name="month" id="month" class="form-select">
                            {% for m in months %}
                            <option value="{{ m.value }}" {% if m.value == selected_month %}selected{% endif %}>
                                {{ m.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="year" class="form-label">Year</label>
                        <select name="year" id="year" class="form-select">
                            {% for y in years %}
                            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>
                                {{ y }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-filter"></i> Filter
                        </button>
                        <a href="?month={{ selected_month }}&year={{ selected_year }}&export=excel"
                           class="btn btn-success">
                            <i class="bi bi-file-earmark-excel"></i> Export Excel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Summary Stats -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="stat-label">Total Invoices</div>
                <div class="stat-value">{{ total_invoices }}</div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="stat-label">Total Amount</div>
                <div class="stat-value">{{ total_amount_formatted }}</div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card stat-card" style="border-left-color: #198754;">
            <div class="card-body">
                <div class="stat-label">Total Paid</div>
                <div class="stat-value" style="color: #198754;">{{ total_paid_formatted }}</div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card stat-card" style="border-left-color: #dc3545;">
            <div class="card-body">
                <div class="stat-label">Total Due</div>
                <div class="stat-value" style="color: #dc3545;">{{ total_due_formatted }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Details Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Invoice Details</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Date</th>
                                <th>Due Date</th>
                                <th>Customer</th>
                                <th>Status</th>
                                <th class="text-end">Amount</th>
                                <th class="text-end">Paid</th>
                                <th class="text-end">Due</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invoice in invoices %}
                            <tr>
                                <td><strong>{{ invoice.invoice_number }}</strong></td>
                                <td>{{ invoice.invoice_date|date:"M d, Y" }}</td>
                                <td>
                                    {% if invoice.due_date %}
                                    {{ invoice.due_date|date:"M d, Y" }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>{{ invoice.customer_name }}</td>
                                <td>
                                    {% if invoice.status_code == "paid" %}
                                    <span class="badge bg-success">{{ invoice.status }}</span>
                                    {% elif invoice.status_code == "overdue" %}
                                    <span class="badge bg-danger">{{ invoice.status }}</span>
                                    {% elif invoice.status_code == "partial_payment" %}
                                    <span class="badge bg-warning">{{ invoice.status }}</span>
                                    {% else %}
                                    <span class="badge bg-info text-dark">{{ invoice.status }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">{{ invoice.total_amount_formatted }}</td>
                                <td class="text-end">{{ invoice.total_paid_formatted }}</td>
                                <td class="text-end">{{ invoice.total_due_formatted }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    No invoices found for {{ month_name }} {{ selected_year }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        {% if invoices %}
                        <tfoot>
                            <tr class="table-secondary">
                                <th colspan="5" class="text-end">TOTAL:</th>
                                <th class="text-end">{{ total_amount_formatted }}</th>
                                <th class="text-end">{{ total_paid_formatted }}</th>
                                <th class="text-end">{{ total_due_formatted }}</th>
                            </tr>
                        </tfoot>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block report_charts %}
<!-- No charts needed for this report -->
{% endblock %}
