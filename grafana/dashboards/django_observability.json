{
    "annotations": {
        "list": []
    },
    "description": "Django Backend observability: Audit events, Core logs, and Worker tasks",
    "title": "Django Observability",
    "templating": {
        "list": [
            {
                "name": "audit_user",
                "type": "query",
                "label": "User",
                "hide": 0,
                "datasource": "Loki",
                "query": "label_values({application=~\".*\", audit=\"true\"}, actor_username)",
                "includeAll": true,
                "allValue": ".*"
            }
        ]
    },
    "panels": [
        {
            "type": "stat",
            "title": "Recent Audit Events (Total)",
            "gridPos": {
                "x": 0,
                "y": 0,
                "w": 6,
                "h": 5
            },
            "targets": [
                {
                    "expr": "sum(count_over_time({application=~\".*\", audit=\"true\"} [5m]))",
                    "refId": "A"
                }
            ]
        },
        {
            "type": "timeseries",
            "title": "Backend Log Levels",
            "gridPos": {
                "x": 6,
                "y": 0,
                "w": 18,
                "h": 5
            },
            "targets": [
                {
                    "expr": "sum by (level) (count_over_time({application=~\".*\"} [1m]))",
                    "legendFormat": "{{level}}",
                    "refId": "A"
                }
            ]
        },
        {
            "type": "table",
            "title": "Audit Trail (CRUD Events)",
            "gridPos": {
                "x": 0,
                "y": 5,
                "w": 24,
                "h": 8
            },
            "targets": [
                {
                    "expr": "{application=~\".*\", audit=\"true\", actor_username=~\"$audit_user\"} | json",
                    "refId": "A"
                }
            ],
            "options": {
                "showHeader": true,
                "columns": [
                    {
                        "text": "Date",
                        "value": "timestamp"
                    },
                    {
                        "text": "User",
                        "value": "actor_username"
                    },
                    {
                        "text": "Action",
                        "value": "action_code"
                    },
                    {
                        "text": "Model",
                        "value": "object_type"
                    },
                    {
                        "text": "Payload",
                        "value": "changes",
                        "type": "json"
                    }
                ],
                "wrapMode": "auto"
            },
            "fieldConfig": {
                "defaults": {
                    "custom": {
                        "json": { "pretty": true }
                    }
                }
            }
        },
        {
            "type": "logs",
            "title": "Django Core Console",
            "gridPos": {
                "x": 0,
                "y": 13,
                "w": 12,
                "h": 10
            },
            "targets": [
                {
                    "expr": "{application=~\".*\", source=\"core\"}",
                    "refId": "A"
                }
            ]
        },
        {
            "type": "logs",
            "title": "Background Worker Logs",
            "gridPos": {
                "x": 12,
                "y": 13,
                "w": 12,
                "h": 10
            },
            "targets": [
                {
                    "expr": "{application=~\".*\", source=\"worker\"}",
                    "refId": "A"
                }
            ]
        }
    ],
    "schemaVersion": 36,
    "version": 1
}