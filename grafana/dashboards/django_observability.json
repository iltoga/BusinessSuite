{
    "annotations": {
        "list": []
    },
    "description": "Django Backend observability: Audit events, Core logs, and Worker tasks",
    "title": "Django Observability",
    "templating": {
        "list": [
            {
                "name": "audit_user",
                "type": "query",
                "label": "User",
                "hide": 0,
                "datasource": "Loki",
                "query": "label_values({application=~\".*\", audit=\"true\"}, actor_username)",
                "includeAll": true,
                "allValue": ".*"
            }
        ]
    },
    "panels": [
        {
            "type": "stat",
            "title": "Recent Audit Events (Total)",
            "gridPos": {
                "x": 0,
                "y": 0,
                "w": 6,
                "h": 5
            },
            "targets": [
                {
                    "expr": "sum(count_over_time({application=~\".*\", audit=\"true\"} [5m]))",
                    "refId": "A"
                }
            ]
        },
        {
            "type": "timeseries",
            "title": "Backend Log Levels",
            "gridPos": {
                "x": 6,
                "y": 0,
                "w": 18,
                "h": 5
            },
            "targets": [
                {
                    "expr": "sum by (level) (count_over_time({application=~\".*\"} [1m]))",
                    "legendFormat": "{{level}}",
                    "refId": "A"
                }
            ]
        },
        {
            "type": "table",
            "title": "Audit Trail (CRUD Events)",
            "gridPos": {
                "x": 0,
                "y": 5,
                "w": 24,
                "h": 8
            },
            "targets": [
                {
                    "expr": "{application=~\".*\", audit=\"true\", actor_username=~\"$audit_user\"} | json",
                    "refId": "A"
                }
            ],
            "transformations": [
                {
                    "id": "labelsToFields"
                },
                {
                    "id": "organize",
                    "options": {
                        "excludeByName": false,
                        "indexByName": false,
                        "include": [
                            "timestamp",
                            "actor_username",
                            "action_code",
                            "object_type",
                            "changes"
                        ],
                        "order": [
                            "timestamp",
                            "actor_username",
                            "action_code",
                            "object_type",
                            "changes"
                        ],
                        "rename": [
                            {
                                "from": "timestamp",
                                "to": "Date"
                            },
                            {
                                "from": "actor_username",
                                "to": "User"
                            },
                            {
                                "from": "action_code",
                                "to": "Action"
                            },
                            {
                                "from": "object_type",
                                "to": "Model"
                            },
                            {
                                "from": "changes",
                                "to": "Payload"
                            }
                        ]
                    }
                }
            ],
            "options": {
                "showHeader": true,
                "columns": [
                    {
                        "text": "Date",
                        "value": "Date"
                    },
                    {
                        "text": "User",
                        "value": "User"
                    },
                    {
                        "text": "Action",
                        "value": "Action"
                    },
                    {
                        "text": "Model",
                        "value": "Model"
                    },
                    {
                        "text": "Payload",
                        "value": "Payload",
                        "type": "json"
                    }
                ],
                "wrapMode": "auto"
            },
            "fieldConfig": {
                "defaults": {
                    "custom": {
                        "json": {
                            "pretty": true
                        }
                    }
                }
            }
        },
        {
            "type": "logs",
            "title": "Django Core Console",
            "gridPos": {
                "x": 0,
                "y": 13,
                "w": 12,
                "h": 10
            },
            "targets": [
                {
                    "expr": "{application=~\".*\", logger=~\"^(django|django\.server|performance)$\"}",
                    "refId": "A"
                }
            ]
        },
        {
            "type": "logs",
            "title": "Background Worker Logs",
            "gridPos": {
                "x": 12,
                "y": 13,
                "w": 12,
                "h": 10
            },
            "targets": [
                {
                    "expr": "{application=~\".*\", source=\"worker\"}",
                    "refId": "A"
                }
            ]
        }
    ],
    "schemaVersion": 36,
    "version": 1
}